{% extends 'expenses/settings_base.html' %}

{% block settings_content %}
<div class="fade-in">
    <div class="mb-4">
        <a href="{% url 'sip-list' %}" class="text-decoration-none text-muted">
            <i class="bi bi-arrow-left me-1"></i> Back to SIPs
        </a>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 py-3">
            <h4 class="mb-0 fw-bold">
                <i class="bi bi-graph-up-arrow text-primary me-2"></i>{{ title }}
            </h4>
        </div>
        <div class="card-body">
            <form method="post" novalidate>
                {% csrf_token %}

                <div class="row g-3">
                    <!-- Fund Name -->
                    <div class="col-12">
                        <label for="id_fund_name" class="form-label fw-bold">Fund Name <span
                                class="text-danger">*</span></label>
                        {{ form.fund_name }}
                        {% if form.fund_name.errors %}
                        <div class="text-danger small mt-1">{{ form.fund_name.errors.0 }}</div>
                        {% endif %}
                        <div class="form-text">e.g., "HDFC Flexi Cap Fund", "Axis Bluechip Fund"</div>
                    </div>

                    <!-- Category & Frequency -->
                    <div class="col-md-6">
                        <label for="id_category" class="form-label fw-bold">Category</label>
                        {{ form.category }}
                        {% if form.category.errors %}
                        <div class="text-danger small mt-1">{{ form.category.errors.0 }}</div>
                        {% endif %}
                        <div class="form-text">Category for expense entries</div>
                    </div>
                    <div class="col-md-6">
                        <label for="id_frequency" class="form-label fw-bold">Frequency <span
                                class="text-danger">*</span></label>
                        {{ form.frequency }}
                        {% if form.frequency.errors %}
                        <div class="text-danger small mt-1">{{ form.frequency.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Amount & Start Date -->
                    <div class="col-md-6">
                        <label for="id_amount_per_installment" class="form-label fw-bold">SIP Amount (â‚¹) <span
                                class="text-danger">*</span></label>
                        {{ form.amount_per_installment }}
                        {% if form.amount_per_installment.errors %}
                        <div class="text-danger small mt-1">{{ form.amount_per_installment.errors.0 }}</div>
                        {% endif %}
                        <div class="form-text">Amount debited per installment</div>
                    </div>
                    <div class="col-md-6">
                        <label for="id_start_date" class="form-label fw-bold">SIP Start Date <span
                                class="text-danger">*</span></label>
                        {{ form.start_date }}
                        {% if form.start_date.errors %}
                        <div class="text-danger small mt-1">{{ form.start_date.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- SIP Day -->
                    <div class="col-md-6">
                        <label for="id_sip_day" class="form-label fw-bold">SIP Day <span
                                class="text-danger">*</span></label>
                        {{ form.sip_day }}
                        {% if form.sip_day.errors %}
                        <div class="text-danger small mt-1">{{ form.sip_day.errors.0 }}</div>
                        {% endif %}
                        <div class="form-text" id="sip-day-help">
                            <span class="monthly-help">Day of month for SIP deduction (1-28)</span>
                            <span class="weekly-help d-none">Day of week: 1=Monday, 2=Tuesday, 3=Wednesday, 4=Thursday,
                                5=Friday, 6=Saturday, 7=Sunday</span>
                            <span class="quarterly-help d-none">Day of month for SIP deduction (1-28)</span>
                        </div>
                    </div>

                    <!-- Active Status -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold d-block">Status</label>
                        <div class="form-check form-switch mt-2">
                            {{ form.is_active }}
                            <label class="form-check-label" for="id_is_active">
                                Active (deductions continuing)
                            </label>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 mt-4 pt-3 border-top">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i> {{ button_text }}
                    </button>
                    <a href="{% url 'sip-list' %}" class="btn btn-outline-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const frequencySelect = document.getElementById('id_frequency');
        const sipDayInput = document.getElementById('id_sip_day');
        const helpTextContainer = document.getElementById('sip-day-help');

        function updateSipDayField() {
            const frequency = frequencySelect.value;
            const monthlyHelp = helpTextContainer.querySelector('.monthly-help');
            const weeklyHelp = helpTextContainer.querySelector('.weekly-help');
            const quarterlyHelp = helpTextContainer.querySelector('.quarterly-help');

            // Hide all help texts
            monthlyHelp.classList.add('d-none');
            weeklyHelp.classList.add('d-none');
            quarterlyHelp.classList.add('d-none');

            if (frequency === 'WEEKLY') {
                weeklyHelp.classList.remove('d-none');
                sipDayInput.max = '7';
                sipDayInput.placeholder = '1';
                if (parseInt(sipDayInput.value) > 7) {
                    sipDayInput.value = '1';
                }
            } else if (frequency === 'MONTHLY') {
                monthlyHelp.classList.remove('d-none');
                sipDayInput.max = '28';
                sipDayInput.placeholder = '1';
            } else if (frequency === 'QUARTERLY') {
                quarterlyHelp.classList.remove('d-none');
                sipDayInput.max = '28';
                sipDayInput.placeholder = '1';
            }
        }

        // Update on page load
        updateSipDayField();

        // Update on frequency change
        frequencySelect.addEventListener('change', updateSipDayField);
    });
</script>
</div>
</div>
{% endblock %}