{% extends 'base.html' %}
{% load static digit_filters i18n %}

{% block content %}
<div class="row justify-content-center text-center mb-5 fade-in">
    <div class="col-lg-8">
        <span class="badge rounded-pill bg-primary bg-opacity-10 text-primary px-3 py-2 mb-3 fw-bold">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none" class="me-1"><style>@keyframes star-twinkle { 0%,100% { opacity: 0.6; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } } .anim-star { animation: star-twinkle 2s ease-in-out infinite; } .anim-star2 { animation: star-twinkle 2s ease-in-out infinite 0.5s; } .anim-star3 { animation: star-twinkle 2s ease-in-out infinite 1s; }</style><path class="anim-star" d="M12 2l1.5 4.5L18 8l-4.5 1.5L12 14l-1.5-4.5L6 8l4.5-1.5z"/><path class="anim-star2" d="M19 14l.75 2.25L22 17l-2.25.75L19 20l-.75-2.25L16 17l2.25-.75z"/><path class="anim-star3" d="M5 16l.5 1.5L7 18l-1.5.5L5 20l-.5-1.5L3 18l1.5-.5z"/></svg> {% trans "Simple, Transparent Pricing" %}
        </span>
        <h1 class="display-4 fw-bold mb-3">{% trans "Choose the plan that fits your financial goals" %}</h1>
        <p class="lead text-muted">{% trans "Start for free, upgrade when you need more power. No hidden fees." %}</p>
    </div>
</div>

<!-- Monthly / Yearly Toggle -->
<div class="row justify-content-center mb-4 fade-in">
    <div class="col-auto">
        <div class="d-flex align-items-center gap-3 bg-body-tertiary rounded-pill px-4 py-2">
            <span id="label-monthly" class="fw-semibold small text-muted">{% trans "Monthly" %}</span>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" role="switch" id="billingToggle" checked
                    style="width: 3em; height: 1.5em; cursor: pointer;">
            </div>
            <span id="label-yearly" class="fw-semibold small">{% trans "Yearly" %}
                <span class="badge bg-success bg-opacity-75 ms-1 rounded-pill" style="font-size: 0.7em;">{% trans "Save ~40%" %}</span>
            </span>
        </div>
    </div>
</div>

<div class="row row-cols-1 row-cols-md-3 mb-3 g-4 text-center fade-in">
    <!-- Free Plan -->
    <div class="col">
        <div class="card mb-4 rounded-4 shadow-sm border-0 h-100 position-relative hover-lift">
            <div class="card-header py-3 bg-transparent border-0">
                <h4 class="my-0 fw-normal">{% trans "Free" %}</h4>
            </div>
            <div class="card-body d-flex flex-column">
                <h1 class="card-title pricing-card-title display-5 fw-bold">₹{{ 0 }}<small class="text-muted fw-light fs-4">/{% trans "mo" %}</small></h1>
                <ul class="list-unstyled mt-3 mb-4 text-start small mx-auto">
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "Unlimited Expenses/Income" %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% blocktrans with count=5 %}{{ count }} Categories{% endblocktrans %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "Basic Reports" %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "1 Savings Goal" %}</li>
                    <li class="mb-2 text-muted"><i class="bi bi-dash-circle me-2"></i>{% trans "Email Reminders" %}</li>
                    <li class="mb-2 text-muted"><i class="bi bi-dash-circle me-2"></i>{% trans "Recurring Transactions" %}</li>
                    <li class="mb-2 text-muted"><i class="bi bi-dash-circle me-2"></i>{% trans "Year in Review" %}</li>
                </ul>
                {% if user.profile.tier == 'FREE' %}
                    <button type="button" class="w-100 btn btn-lg btn-outline-primary mt-auto rounded-pill fw-bold" disabled>{% trans "Current Plan" %}</button>
                {% else %}
                    <a href="#" class="w-100 btn btn-lg btn-outline-secondary mt-auto rounded-pill fw-bold disabled">{% trans "Included" %}</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Plus Plan -->
    <div class="col">
        <div class="card mb-4 rounded-4 shadow border-primary h-100 position-relative transform-scale-sm">
            <div class="position-absolute top-0 start-50 translate-middle">
                <span class="badge rounded-pill text-bg-primary px-3 py-2 shadow-sm">{% trans "MOST POPULAR" %}</span>
            </div>
            <div class="card-header py-3 bg-primary bg-opacity-10 border-0">
                <h4 class="my-0 fw-bold text-primary">{% trans "Plus" %} <span class="badge bg-danger ms-2 rounded-pill" style="font-size: 0.6em;">{% trans "LIMITED OFFER" %}</span></h4>
            </div>
            <div class="card-body d-flex flex-column">
                <h1 class="card-title pricing-card-title display-5 fw-bold">
                    <span class="plan-price"
                        data-monthly="{{ plans_monthly.PLUS.price|default:'0'|floatformat:0 }}"
                        data-yearly="{{ plans_yearly.PLUS.price|default:'0'|floatformat:0 }}">
                        ₹{% if plans_yearly.PLUS %}{{ plans_yearly.PLUS.price|floatformat:0 }}{% else %}0{% endif %}
                    </span>
                    <small class="text-muted fw-light fs-4 plan-suffix">/{% trans "yr" %}</small>
                </h1>
                <ul class="list-unstyled mt-3 mb-4 text-start small mx-auto">
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "Everything in Free" %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% blocktrans with count=10 %}{{ count }} Categories{% endblocktrans %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% blocktrans with count=3 %}{{ count }} Recurring Transactions{% endblocktrans %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "3 Savings Goals" %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "Email Reminders" %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "Export to CSV/Excel" %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "Year in Review" %}</li>
                </ul>
                {% if user.profile.tier == 'PLUS' and user.profile.is_plus %}
                     <button type="button" class="w-100 btn btn-lg btn-outline-primary mt-auto rounded-pill fw-bold" disabled>{% trans "Current Plan" %}</button>
                {% elif user.profile.is_pro %}
                     <button type="button" class="w-100 btn btn-lg btn-outline-primary mt-auto rounded-pill fw-bold" disabled>{% trans "Included" %}</button>
                {% else %}
                    <button onclick="startPayment('PLUS')" class="w-100 btn btn-lg btn-primary mt-auto rounded-pill fw-bold shadow-lg">{% trans "Upgrade to Plus" %}</button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Pro Plan -->
    <div class="col">
        <div class="card mb-4 rounded-4 shadow-sm border-0 h-100 position-relative hover-lift">
            <div class="card-header py-3 bg-transparent border-0">
                <h4 class="my-0 fw-normal">{% trans "Pro" %} <span class="badge bg-danger ms-2 rounded-pill" style="font-size: 0.6em;">{% trans "LIMITED OFFER" %}</span></h4>
            </div>
            <div class="card-body d-flex flex-column">
                <h1 class="card-title pricing-card-title display-5 fw-bold">
                    <span class="plan-price"
                        data-monthly="{{ plans_monthly.PRO.price|default:'0'|floatformat:0 }}"
                        data-yearly="{{ plans_yearly.PRO.price|default:'0'|floatformat:0 }}">
                        ₹{% if plans_yearly.PRO %}{{ plans_yearly.PRO.price|floatformat:0 }}{% else %}0{% endif %}
                    </span>
                    <small class="text-muted fw-light fs-4 plan-suffix">/{% trans "yr" %}</small>
                </h1>
                <ul class="list-unstyled mt-3 mb-4 text-start small mx-auto">
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "Everything in Plus" %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "Unlimited Categories" %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "Unlimited Recurring Txs" %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "Unlimited Savings Goals" %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "Email Reminders" %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "Priority Support" %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "Year in Review" %}</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>{% trans "AI Insights" %}</li>
                </ul>
                 {% if user.profile.is_pro %}
                    <button type="button" class="w-100 btn btn-lg btn-outline-primary mt-auto rounded-pill fw-bold" disabled>{% trans "Current Plan" %}</button>
                {% else %}
                     {% if user.profile.can_start_trial %}
                        <button onclick="startTrial()" class="w-100 btn btn-lg btn-success mt-auto rounded-pill fw-bold mb-2 shadow-sm">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2" style="vertical-align: -3px;"><style>@keyframes gift-bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-3px); } } .anim-gift { animation: gift-bounce 2s ease-in-out infinite; }</style><rect x="3" y="8" width="18" height="14" rx="2" class="anim-gift" fill="currentColor" fill-opacity="0.15"/><path d="M12 8v14M3 12h18" class="anim-gift"/><path d="M12 8c-2-3-6-3-6 0s4 0 6 0c2-3 6-3 6 0s-4 0-6 0" class="anim-gift"/></svg>{% trans "Start 7-Day Free Trial" %}
                        </button>
                        <button onclick="startPayment('PRO')" class="w-100 btn btn-outline-primary rounded-pill fw-bold">{% trans "Buy Pro Now" %}</button>
                     {% else %}
                        <button onclick="startPayment('PRO')" class="w-100 btn btn-lg btn-outline-primary mt-auto rounded-pill fw-bold">{% trans "Go Pro" %}</button>
                     {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- FAQ Section -->
<div class="row justify-content-center mt-5 fade-in" style="animation-delay: 0.2s;">
    <div class="col-lg-8">
        <h3 class="text-center fw-bold mb-4">{% trans "Frequently Asked Questions" %}</h3>
        <div class="accordion accordion-flush" id="pricingFAQ">
             <!-- ... FAQs ... -->
             <div class="accordion-item bg-transparent">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed bg-transparent" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                        {% trans "Can I switch plans later?" %}
                    </button>
                </h2>
                <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                    <div class="accordion-body text-muted">{% trans "A: Absolutely! You can upgrade your plan at any time." %}</div>
                </div>
            </div>
             <div class="accordion-item bg-transparent">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed bg-transparent" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                         {% trans "What payment methods are accepted?" %}
                    </button>
                </h2>
                <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                    <div class="accordion-body text-muted">{% trans "A: We accept all major Credit/Debit Cards, UPI, and Netbanking via Razorpay." %}</div>
                </div>
            </div>
             <div class="accordion-item bg-transparent">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed bg-transparent" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                         {% trans "Can I switch between monthly and yearly?" %}
                    </button>
                </h2>
                <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                    <div class="accordion-body text-muted">{% trans "A: Yes! You can switch billing cycles when your current period expires." %}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
// Track current billing duration
let currentDuration = 'YEARLY';

// Toggle handler
const billingToggle = document.getElementById('billingToggle');
const labelMonthly = document.getElementById('label-monthly');
const labelYearly = document.getElementById('label-yearly');

function updatePricing() {
    const isYearly = billingToggle.checked;
    currentDuration = isYearly ? 'YEARLY' : 'MONTHLY';

    // Update label styles
    labelMonthly.classList.toggle('text-muted', isYearly);
    labelMonthly.classList.toggle('fw-bold', !isYearly);
    labelYearly.classList.toggle('text-muted', !isYearly);
    labelYearly.classList.toggle('fw-bold', isYearly);

    // Update prices
    document.querySelectorAll('.plan-price').forEach(el => {
        const price = isYearly ? el.dataset.yearly : el.dataset.monthly;
        el.textContent = '₹' + price;
    });

    // Update suffix
    const suffixText = isYearly ? '/yr' : '/mo';
    document.querySelectorAll('.plan-suffix').forEach(el => {
        el.textContent = suffixText;
    });
}

billingToggle.addEventListener('change', updatePricing);

// Start 7-Day Trial
function startTrial() {
    if (!confirm('Start your 7-Day Pro Free Trial? No credit card required.')) return;
    
    showLoader();
    fetch("{% url 'start-trial' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoader();
        if (data.success) {
            alert(data.message);
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        hideLoader();
        console.error('Error:', error);
        alert('Something went wrong. Please try again.');
    });
}

async function startPayment(planType) {
    try {
        const response = await fetch("{% url 'create-order' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({plan_type: planType, duration: currentDuration})
        });
        
        const orderData = await response.json();
        
        if (orderData.error) {
            alert('Error: ' + orderData.error);
            return;
        }

        const durationLabel = currentDuration === 'MONTHLY' ? 'Monthly' : 'Yearly';

        var options = {
            "key": "{{ RAZORPAY_KEY_ID }}",
            "name": "TrackMyRupee",
            "description": "Upgrade to " + planType + " (" + durationLabel + ")",
            "order_id": orderData.id, 
            "handler": async function (response){
                // Verify Payment on Server
                const verifyRes = await fetch("{% url 'verify-payment' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                         'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_signature: response.razorpay_signature
                    })
                });
                
                const verifyData = await verifyRes.json();
                if (verifyData.success) {
                    window.location.href = "{% url 'settings-home' %}?upgraded=true";
                } else {
                    alert("Payment Verification Failed: " + verifyData.error);
                }
            },
            "prefill": {
                "name": "{{ user.username }}",
                "email": "{{ user.email }}",
                "contact": "9999999999"
            },
            "theme": {
                "color": "#0d6efd"
            }
        };
        var rzp1 = new Razorpay(options);
        rzp1.open();
        
    } catch (e) {
        console.error(e);
        alert('Something went wrong. Please try again.');
    }
}
</script>
{% endblock %}
