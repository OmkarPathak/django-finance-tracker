{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-lg border-0">
            <div class="card-header fw-bold py-3">
                <h4 class="card-title mb-0 h5">
                {% if object %}Edit Expense{% else %}New Expense{% endif %}
                </h4>
            </div>
            <div class="card-body p-4">
                <form method="post">
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    {% if formset %}
                        {{ formset.management_form }}
                        <div class="table-responsive">
                            <table class="table table-borderless align-top" id="formset-table">
                                <thead>
                                    <tr>
                                        <th style="min-width: 140px;">Date</th>
                                        <th style="min-width: 130px;">Amount</th>
                                        <th style="min-width: 200px;">Description</th>
                                        <th style="min-width: 200px;">Category</th>
                                        <th style="min-width: 150px;">Payment Method</th>
                                        <th style="min-width: 100px;">Cashback</th>
                                        <th style="width: 50px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="formset-container">
                                    {% for form in formset %}
                                    <tr class="form-row">
                                        {% for field in form %}
                                            {% if field.name in 'date,amount,description,category,payment_method' %}
                                            <td class="p-1">
                                                {% if forloop.first %}
                                                    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                                                {% endif %}
                                                
                                                {% if field.name == 'category' %}
                                                    <div class="input-group">
                                                        {{ field }}
                                                        <button type="button" class="btn btn-outline-secondary add-category-btn"
                                                                title="Add new category">
                                                            <i class="bi bi-plus-lg"></i>
                                                        </button>
                                                    </div>
                                                {% elif field.name == 'payment_method' %}
                                                    {{ field }}
                                                {% else %}
                                                    <input type="{% if field.name == 'date' %}date{% else %}{{ field.field.widget.input_type|default:'text' }}{% endif %}" 
                                                        name="{{ field.html_name }}" 
                                                        class="form-control"
                                                        {% if field.value %}value="{{ field.value|date:'Y-m-d'|default:field.value }}"{% endif %} 
                                                        {% if field.field.required %}required{% endif %}
                                                        id="{{ field.id_for_label }}"
                                                        placeholder="{{ field.label }}"
                                                        {% if field.field.widget.input_type == "number" %}step="0.01"{% endif %}>
                                                {% endif %}

                                                {% if field.errors %}
                                                    <div class="text-danger small" style="font-size: 0.7rem;">{{ field.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            {% endif %}
                                        {% endfor %}
                                        <td class="p-1">
                                            <button type="button" class="btn btn-sm btn-outline-secondary cashback-toggle-btn" 
                                                    title="Add cashback" 
                                                    data-row-index="{{ forloop.counter0 }}">
                                                <i class="bi bi-cash-coin"></i>
                                            </button>
                                            <div class="cashback-fields d-none mt-2" id="cashback-{{ forloop.counter0 }}">
                                                {% for field in form %}
                                                    {% if field.name == 'has_cashback' %}
                                                        <input type="hidden" name="{{ field.html_name }}" value="false" class="cashback-enabled">
                                                    {% elif field.name == 'cashback_type' %}
                                                        <select name="{{ field.html_name }}" class="form-select form-select-sm mb-1">
                                                            <option value="">Type</option>
                                                            <option value="PERCENTAGE">%</option>
                                                            <option value="FIXED">{{ currency_symbol }}</option>
                                                        </select>
                                                    {% elif field.name == 'cashback_value' %}
                                                        <input type="number" 
                                                               name="{{ field.html_name }}" 
                                                               class="form-control form-control-sm" 
                                                               placeholder="Value"
                                                               step="0.01"
                                                               min="0">
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            {% if form.instance.pk %}
                                                <div class="d-none">{{ form.DELETE }}</div> <!-- Hidden actual checkbox -->
                                                <button type="button" class="btn btn-sm btn-link text-danger p-0 delete-row" 
                                                        title="Delete existing expense">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-sm btn-link text-danger p-0 remove-row" 
                                                        title="Remove row">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary mb-3" id="add-form">
                            <i class="bi bi-plus-lg me-1"></i> Add Row
                        </button>
                    
                    {% else %}
                    
                        <!-- Expense Type Selection -->
                        <div class="mb-4">
                            <label class="form-label text-muted fw-bold">Expense Type</label>
                            <div class="d-flex gap-3">
                                {% for value, label in form.expense_type.field.choices %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="expense_type" 
                                           id="expense_type_{{ value }}" value="{{ value }}"
                                           {% if form.expense_type.value == value or value == 'personal' and not form.expense_type.value %}checked{% endif %}>
                                    <label class="form-check-label" for="expense_type_{{ value }}">
                                        {{ label }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Regular Expense Fields -->
                        {% for field in form %}
                        {% if field.name != 'cashback_type' and field.name != 'cashback_value' and field.name != 'has_cashback' and field.name != 'expense_type' and field.name != 'participants_json' and field.name != 'payer_id' %}
                        <div class="mb-3">
                            <label class="form-label text-muted">{{ field.label }}</label>
                            {% if field.field.widget.input_type == "checkbox" %}
                                <div class="form-check">
                                    {{ field }}
                                    <label class="form-check-label" for="{{ field.id_for_label }}">
                                        {{ field.help_text }}
                                    </label>

                                </div>
                            {% elif field.name == 'category' %}
                                <div class="input-group">
                                    {{ field }}
                                    <button type="button" class="btn btn-outline-secondary add-category-btn"
                                            title="Add new category">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                            {% elif field.name == 'payment_method' %}
                                {{ field }}
                            {% else %}
                                <input type="{% if field.name == 'date' %}date{% else %}{{ field.field.widget.input_type|default:'text' }}{% endif %}" 
                                    name="{{ field.name }}" 
                                    class="form-control"
                                    {% if field.value %}value="{{ field.value|date:'Y-m-d'|default:field.value }}"{% endif %} 
                                    {% if field.field.required %}required{% endif %}
                                    {% if field.field.widget.input_type == "number" %}step="0.01"{% endif %}>
                            {% endif %}
                            
                            {% if field.errors %}
                            <div class="text-danger small mt-1">{{ field.errors.0 }}</div>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endfor %}

                        <!-- Shared Expense Section (Hidden by default) -->
                        <div id="shared-expense-section" class="d-none">
                            <div class="card bg-light border-0 mb-3">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-3 text-success">
                                        <i class="bi bi-people me-2"></i>Shared Expense Details
                                    </h6>
                                    
                                    <!-- Participants Section -->
                                    <div class="mb-3">
                                        <label class="form-label text-success">Participants</label>
                                        <div id="participants-container"></div>
                                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-participant-btn">
                                            <i class="bi bi-plus-lg me-1"></i> Add Participant
                                        </button>
                                    </div>

                                    <!-- Payer Selection -->
                                    <div class="mb-3">
                                        <label class="form-label text-success">Who Paid?</label>
                                        <select id="payer-select" class="form-select">
                                            <option value="">Select payer...</option>
                                        </select>
                                    </div>

                                    <!-- Validation Messages -->
                                    <div id="share-validation-message" class="alert alert-warning d-none">
                                        <small><strong>Remaining to allocate:</strong> <span id="remaining-amount">{{ currency_symbol }}0</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden fields for shared expense data -->
                        {{ form.participants_json }}
                        {{ form.payer_id }}

                        <!-- Cashback Toggle -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                {{ form.has_cashback }}
                                <label class="form-check-label" for="{{ form.has_cashback.id_for_label }}">
                                    <i class="bi bi-cash-coin me-1"></i>Apply Cashback
                                </label>
                            </div>
                        </div>

                        <!-- Cashback Section -->
                        <div id="cashback-section" class="{% if not form.has_cashback.value %}d-none{% endif %}">
                            <div class="card bg-light border-0 mb-3">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-3 text-muted">
                                        <i class="bi bi-cash-coin me-2"></i>Cashback Details
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label text-muted">{{ form.cashback_type.label }}</label>
                                            {{ form.cashback_type }}
                                            {% if form.cashback_type.errors %}
                                            <div class="text-danger small mt-1">{{ form.cashback_type.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label text-muted">{{ form.cashback_value.label }}</label>
                                            <input type="number" 
                                                name="{{ form.cashback_value.name }}" 
                                                class="form-control"
                                                {% if form.cashback_value.value %}value="{{ form.cashback_value.value }}"{% endif %} 
                                                step="0.01"
                                                min="0"
                                                placeholder="Enter value">
                                            {% if form.cashback_value.errors %}
                                            <div class="text-danger small mt-1">{{ form.cashback_value.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div id="cashback-preview" class="alert alert-info mb-0" style="display: none;">
                                        <small>
                                            <strong>Cashback:</strong> <span id="cashback-amount">{{ currency_symbol }}0</span><br>
                                            <strong>Effective Amount:</strong> <span id="effective-amount">{{ currency_symbol }}0</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                    {% endif %}

                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i> Save Changes
                        </button>
                        
                        <input type="hidden" name="next" value="{{ next_url }}">
                        <a href="{{ next_url|default:'/expenses/' }}" class="btn btn-outline-secondary px-4">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger d-none" id="categoryError"></div>
                    <form id="addCategoryForm">
                        <div class="mb-3">
                            <label for="newCategoryName" class="form-label">Category Name</label>
                            <input type="text" class="form-control" id="newCategoryName" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveCategoryBtn">Save Category</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    const currencySymbol = '{{ currency_symbol }}';
    document.addEventListener('DOMContentLoaded', function() {
        // --- Expense Type Toggle Logic ---
        const expenseTypeRadios = document.querySelectorAll('input[name="expense_type"]');
        const sharedExpenseSection = document.getElementById('shared-expense-section');
        
        // --- Participant Management Logic ---
        let participants = [];
        const participantsContainer = document.getElementById('participants-container');
        const addParticipantBtn = document.getElementById('add-participant-btn');
        const participantsJsonInput = document.querySelector('input[name="participants_json"]');
        
        // Only proceed if we're in single form mode (not formset)
        if (participantsContainer && addParticipantBtn && participantsJsonInput) {
            
            // Initialize participants from hidden field (includes pre-populated user)
            function initializeParticipants() {
                try {
                    const jsonValue = participantsJsonInput.value;
                    console.log('Initializing participants with JSON:', jsonValue);
                    if (jsonValue) {
                        participants = JSON.parse(jsonValue);
                    } else {
                        participants = [];
                    }
                } catch (e) {
                    console.error('Error parsing participants JSON:', e);
                    participants = [];
                }
                
                console.log('Participants loaded:', participants);
                renderParticipants();
            }
        
            // Render all participants
            function renderParticipants() {
                participantsContainer.innerHTML = '';
                
                participants.forEach((participant, index) => {
                    const participantDiv = document.createElement('div');
                    participantDiv.className = 'participant-row mb-2 p-2 border rounded bg-white';
                    participantDiv.innerHTML = `
                        <div class="row g-2 align-items-center">
                            <div class="col-md-5">
                                <input type="text" 
                                       class="form-control form-control-sm participant-name" 
                                       placeholder="Participant name"
                                       value="${participant.name || ''}"
                                       data-index="${index}"
                                       ${participant.is_user ? 'readonly' : ''}>
                            </div>
                            <div class="col-md-5">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">${currencySymbol}</span>
                                    <input type="number"
                                           class="form-control participant-share" 
                                           placeholder="Share amount"
                                           value="${participant.share_amount || ''}"
                                           data-index="${index}"
                                           step="0.01"
                                           min="0">
                                </div>
                            </div>
                            <div class="col-md-2 text-end">
                                ${!participant.is_user ? `
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-danger remove-participant-btn" 
                                            data-index="${index}"
                                            title="Remove participant">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                ` : `
                                    <span class="badge bg-primary">You</span>
                                `}
                            </div>
                        </div>
                    `;
                    
                    participantsContainer.appendChild(participantDiv);
                });
                
                // Attach event listeners
                attachParticipantEventListeners();
                updateParticipantsJson();
                updatePayerDropdown();
                calculateShares();
            }
            
            // Attach event listeners to participant inputs
            function attachParticipantEventListeners() {
                // Name inputs
                document.querySelectorAll('.participant-name').forEach(input => {
                    input.addEventListener('input', function() {
                        const index = parseInt(this.dataset.index);
                        participants[index].name = this.value.trim();
                        updateParticipantsJson();
                        updatePayerDropdown();
                    });
                });
                
                // Share amount inputs
                document.querySelectorAll('.participant-share').forEach(input => {
                    input.addEventListener('input', function() {
                        const index = parseInt(this.dataset.index);
                        participants[index].share_amount = this.value;
                        updateParticipantsJson();
                        calculateShares();
                    });
                });
                
                // Remove buttons
                document.querySelectorAll('.remove-participant-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        participants.splice(index, 1);
                        renderParticipants();
                    });
                });
            }
            
            // Add new participant
            addParticipantBtn.addEventListener('click', function() {
                participants.push({
                    name: '',
                    share_amount: '',
                    is_user: false
                });
                renderParticipants();
            });
            
            // Update hidden JSON field
            function updateParticipantsJson() {
                participantsJsonInput.value = JSON.stringify(participants);
            }
            
            // --- Payer Selection Logic ---
            const payerSelect = document.getElementById('payer-select');
            const payerIdInput = document.querySelector('input[name="payer_id"]');
            
            // Update payer dropdown with current participants
            function updatePayerDropdown() {
                if (!payerSelect || !payerIdInput) return;
                
                const currentPayer = payerIdInput.value;
                payerSelect.innerHTML = '<option value="">Select payer...</option>';
                
                participants.forEach(participant => {
                    if (participant.name && participant.name.trim()) {
                        const option = document.createElement('option');
                        option.value = participant.name.trim();
                        option.textContent = participant.name.trim();
                        
                        // Mark as selected if it matches current payer
                        if (participant.name.trim() === currentPayer) {
                            option.selected = true;
                        }
                        
                        // Set user as default payer if no payer selected yet
                        if (!currentPayer && participant.is_user) {
                            option.selected = true;
                            payerIdInput.value = participant.name.trim();
                        }
                        
                        payerSelect.appendChild(option);
                    }
                });
            }
            
            // Handle payer selection change
            if (payerSelect) {
                payerSelect.addEventListener('change', function() {
                    if (payerIdInput) payerIdInput.value = this.value;
                });
            }
            
            // --- Share Amount Calculation and Validation ---
            const amountInput = document.querySelector('input[name="amount"]');
            const shareValidationMessage = document.getElementById('share-validation-message');
            const remainingAmountSpan = document.getElementById('remaining-amount');
            
            // Calculate equal split when participants are added or amount changes
            function calculateEqualSplit() {
                const totalAmount = parseFloat(amountInput?.value) || 0;
                const participantCount = participants.length;
                
                if (totalAmount > 0 && participantCount > 0) {
                    const equalShare = (totalAmount / participantCount).toFixed(2);
                    
                    // Only update shares that are empty
                    participants.forEach(participant => {
                        if (!participant.share_amount || participant.share_amount === '') {
                            participant.share_amount = equalShare;
                        }
                    });
                    
                    renderParticipants();
                }
            }
            
            // Calculate and display remaining amount
            function calculateShares() {
                const totalAmount = parseFloat(amountInput?.value) || 0;
                
                if (totalAmount <= 0) {
                    shareValidationMessage.classList.add('d-none');
                    return;
                }
                
                let totalShares = 0;
                participants.forEach(participant => {
                    const shareAmount = parseFloat(participant.share_amount) || 0;
                    totalShares += shareAmount;
                });
                
                const remaining = totalAmount - totalShares;
                
                if (Math.abs(remaining) > 0.01) {
                    shareValidationMessage.classList.remove('d-none');
                    remainingAmountSpan.textContent = currencySymbol + remaining.toFixed(2);

                    // Change alert class based on whether we're over or under
                    if (remaining < 0) {
                        shareValidationMessage.classList.remove('alert-warning');
                        shareValidationMessage.classList.add('alert-danger');
                        remainingAmountSpan.parentElement.innerHTML = '<strong>Over-allocated by:</strong> <span id="remaining-amount">' + currencySymbol + Math.abs(remaining).toFixed(2) + '</span>';
                    } else {
                        shareValidationMessage.classList.remove('alert-danger');
                        shareValidationMessage.classList.add('alert-warning');
                        remainingAmountSpan.parentElement.innerHTML = '<strong>Remaining to allocate:</strong> <span id="remaining-amount">' + currencySymbol + remaining.toFixed(2) + '</span>';
                    }
                } else {
                    shareValidationMessage.classList.add('d-none');
                }
            }
            
            // Listen to amount changes
            if (amountInput) {
                amountInput.addEventListener('input', function() {
                    calculateEqualSplit();
                    calculateShares();
                });
            }
            
            // Add button to auto-split equally
            addParticipantBtn.insertAdjacentHTML('afterend', `
                <button type="button" class="btn btn-sm btn-outline-secondary mt-2 ms-2" id="auto-split-btn">
                    <i class="bi bi-calculator me-1"></i> Split Equally
                </button>
            `);
            
            document.getElementById('auto-split-btn').addEventListener('click', function() {
                const totalAmount = parseFloat(amountInput?.value) || 0;
                const participantCount = participants.length;
                
                if (totalAmount > 0 && participantCount > 0) {
                    const equalShare = (totalAmount / participantCount).toFixed(2);
                    
                    // Update all shares
                    participants.forEach(participant => {
                        participant.share_amount = equalShare;
                    });
                    
                    // Adjust last participant's share to account for rounding
                    if (participants.length > 0) {
                        let totalShares = 0;
                        for (let i = 0; i < participants.length - 1; i++) {
                            totalShares += parseFloat(participants[i].share_amount);
                        }
                        participants[participants.length - 1].share_amount = (totalAmount - totalShares).toFixed(2);
                    }
                    
                    renderParticipants();
                }
            });

        } // End of participant management if block
        
        function toggleExpenseType() {
            const selectedType = document.querySelector('input[name="expense_type"]:checked')?.value;
            
            if (selectedType === 'shared') {
                sharedExpenseSection.classList.remove('d-none');
                if (participantsContainer) {
                    initializeParticipants();
                }
            } else {
                sharedExpenseSection.classList.add('d-none');
            }
        }
        
        expenseTypeRadios.forEach(radio => {
            radio.addEventListener('change', toggleExpenseType);
        });
        
        // Initialize on page load
        toggleExpenseType();

        // --- Cashback Toggle Logic ---
        const hasCashbackCheckbox = document.getElementById('id_has_cashback');
        const cashbackSection = document.getElementById('cashback-section');
        const amountInput = document.querySelector('input[name="amount"]');
        const cashbackTypeSelect = document.querySelector('select[name="cashback_type"]');
        const cashbackValueInput = document.querySelector('input[name="cashback_value"]');
        const cashbackPreview = document.getElementById('cashback-preview');
        const cashbackAmountSpan = document.getElementById('cashback-amount');
        const effectiveAmountSpan = document.getElementById('effective-amount');

        if (hasCashbackCheckbox && cashbackSection) {
            hasCashbackCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    cashbackSection.classList.remove('d-none');
                } else {
                    cashbackSection.classList.add('d-none');
                    if (cashbackPreview) cashbackPreview.style.display = 'none';
                }
            });

            // Calculate and show cashback preview
            function updateCashbackPreview() {
                const amount = parseFloat(amountInput?.value) || 0;
                const cashbackType = cashbackTypeSelect?.value;
                const cashbackValue = parseFloat(cashbackValueInput?.value) || 0;

                if (hasCashbackCheckbox?.checked && amount > 0 && cashbackValue > 0 && cashbackType) {
                    let cashbackAmount = 0;
                    
                    if (cashbackType === 'PERCENTAGE') {
                        cashbackAmount = (amount * cashbackValue) / 100;
                    } else if (cashbackType === 'FIXED') {
                        cashbackAmount = cashbackValue;
                    }

                    const effectiveAmount = amount - cashbackAmount;

                    if (cashbackAmountSpan) cashbackAmountSpan.textContent = currencySymbol + cashbackAmount.toFixed(2);
                    if (effectiveAmountSpan) effectiveAmountSpan.textContent = currencySymbol + effectiveAmount.toFixed(2);
                    if (cashbackPreview) cashbackPreview.style.display = 'block';
                } else {
                    if (cashbackPreview) cashbackPreview.style.display = 'none';
                }
            }

            // Attach event listeners for real-time preview
            if (amountInput) amountInput.addEventListener('input', updateCashbackPreview);
            if (cashbackTypeSelect) cashbackTypeSelect.addEventListener('change', updateCashbackPreview);
            if (cashbackValueInput) cashbackValueInput.addEventListener('input', updateCashbackPreview);

            // Initial preview on page load
            updateCashbackPreview();
        }

        // --- Formset Logic ---
        const addBtn = document.getElementById('add-form');
        const container = document.getElementById('formset-container');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');

        // Cashback toggle for formset rows
        document.body.addEventListener('click', function(e) {
            if (e.target.closest('.cashback-toggle-btn')) {
                const btn = e.target.closest('.cashback-toggle-btn');
                const rowIndex = btn.getAttribute('data-row-index');
                const cashbackDiv = document.getElementById('cashback-' + rowIndex);
                const cashbackEnabledInput = cashbackDiv.querySelector('.cashback-enabled');
                
                if (cashbackDiv.classList.contains('d-none')) {
                    cashbackDiv.classList.remove('d-none');
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-success');
                    if (cashbackEnabledInput) cashbackEnabledInput.value = 'true';
                } else {
                    cashbackDiv.classList.add('d-none');
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                    if (cashbackEnabledInput) cashbackEnabledInput.value = 'false';
                    // Clear cashback fields
                    cashbackDiv.querySelectorAll('input, select').forEach(input => {
                        if (!input.classList.contains('cashback-enabled')) {
                            input.value = '';
                        }
                    });
                }
            }
        });

        // Add Row
        if (addBtn) {
            addBtn.addEventListener('click', function() {
                const currentFormCount = parseInt(totalForms.value);
                const forms = container.getElementsByClassName('form-row');
                
                let templateRow = forms[forms.length - 1];
                let newForm = templateRow.cloneNode(true);
                
                const regex = new RegExp(`form-(\\d+)-`, 'g');
                newForm.innerHTML = newForm.innerHTML.replace(regex, `form-${currentFormCount}-`);
                
                // Update cashback button data-row-index and cashback div id
                const cashbackBtn = newForm.querySelector('.cashback-toggle-btn');
                if (cashbackBtn) {
                    cashbackBtn.setAttribute('data-row-index', currentFormCount);
                    cashbackBtn.classList.remove('btn-success');
                    cashbackBtn.classList.add('btn-outline-secondary');
                }
                
                const cashbackDiv = newForm.querySelector('[id^="cashback-"]');
                if (cashbackDiv) {
                    cashbackDiv.id = 'cashback-' + currentFormCount;
                    cashbackDiv.classList.add('d-none');
                }
                
                const inputs = newForm.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.name.includes('date')) {
                        input.value = new Date().toISOString().split('T')[0];
                    } else if (input.classList.contains('cashback-enabled')) {
                        input.value = 'false';
                    } else {
                        input.value = '';
                    }
                    input.classList.remove('is-invalid');
                    if(input.type === 'checkbox' || input.type === 'radio') input.checked = false;
                });
                
                // Reset text content of non-inputs if any
                newForm.querySelectorAll('.text-danger').forEach(el => el.remove());
                
                // Change delete button to remove button
                const actionCell = newForm.querySelector('td.text-center');
                actionCell.innerHTML = `
                    <button type="button" class="btn btn-sm btn-link text-danger p-0 remove-row" title="Remove row">
                        <i class="bi bi-x-circle"></i>
                    </button>
                `;

                container.appendChild(newForm);
                totalForms.value = currentFormCount + 1;
            });
        }

        // Delegate click for remove/delete
        container.addEventListener('click', function(e) {
            // Handle Remove (New Row)
            if (e.target.closest('.remove-row')) {
                const row = e.target.closest('tr');
                row.remove();
                updateFormIndices();
            }
            
            // Handle Delete (Existing Row)
            if (e.target.closest('.delete-row')) {
                const row = e.target.closest('tr');
                const deleteInput = row.querySelector('input[name$="-DELETE"]');
                if (deleteInput) {
                    deleteInput.checked = true;
                    row.style.display = 'none';
                    // We don't verify fields on hidden rows, but good execution would require bypassing required attrs.
                    // However, standard browser form submission might block if hidden inputs are required. 
                    // Django forms usually don't put 'required' on fields if it's conditional, but we rely on browser.
                    // Let's remove 'required' from inputs in this row to avoid submission errors.
                    row.querySelectorAll('input, select').forEach(input => {
                        input.removeAttribute('required');
                    });
                }
            }
        });

        function updateFormIndices() {
            // Re-index all forms to avoid validation errors with ManagementForm
            const rows = container.querySelectorAll('.form-row');
            totalForms.value = rows.length;
            
            rows.forEach((row, index) => {
                // Determine pattern for current row based on its existing content (usually form-N-)
                // But simpler: just replace ANY form-\d+- with form-index- in the attributes we care about.
                
                // Update inputs, selects, textareas
                const inputs = row.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.name) {
                        input.name = input.name.replace(/form-\d+-/, `form-${index}-`);
                    }
                    if (input.id) {
                        input.id = input.id.replace(/form-\d+-/, `form-${index}-`);
                    }
                });

                // Update labels if any (though we use little labels in this table)
                row.querySelectorAll('label').forEach(label => {
                    if (label.htmlFor) {
                        label.htmlFor = label.htmlFor.replace(/form-\d+-/, `form-${index}-`);
                    }
                });
                
                // Update hidden DELETE inputs or other specifics if needed
                // The above generic input handler covers typical django form fields.
            });
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Dynamic Category Logic ---
        const modalEl = document.getElementById('addCategoryModal');
        // Check if modal exists (might not be rendered if not authenticated or other reasons, though unlikely here)
        if (modalEl) {
            const modal = new bootstrap.Modal(modalEl);
            const saveBtn = document.getElementById('saveCategoryBtn');
            const errorAlert = document.getElementById('categoryError');
            let activeSelectId = null; 

            // Delegation for + buttons (covers both formset and single form)
            // We attach to document.body to ensure we catch everything, or a common wrapper if available.
            document.body.addEventListener('click', function(e) {
                const btn = e.target.closest('.add-category-btn');
                if (btn) {
                    const select = btn.previousElementSibling;
                    activeSelectId = select.id;
                    document.getElementById('addCategoryForm').reset();
                    errorAlert.classList.add('d-none');
                    modal.show();
                    setTimeout(() => document.getElementById('newCategoryName').focus(), 500);
                }
            });

            saveBtn.addEventListener('click', function() {
                const nameInput = document.getElementById('newCategoryName');
                const name = nameInput.value.trim();
                
                if (!name) {
                    errorAlert.textContent = "Category name cannot be empty.";
                    errorAlert.classList.remove('d-none');
                    return;
                }

                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

                fetch("{% url 'category-create-ajax' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ name: name })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const allSelects = document.querySelectorAll('select[name*="category"]'); // Matches 'category' in name
                        allSelects.forEach(select => {
                            // Check if option exists
                            let exists = false;
                            for (let i = 0; i < select.options.length; i++) {
                                if (select.options[i].value === data.name) {
                                    exists = true;
                                    break;
                                }
                            }
                            if (!exists) {
                                const option = new Option(data.name, data.name);
                                select.add(option);
                            }
                        });

                        if (activeSelectId) {
                            const activeEl = document.getElementById(activeSelectId);
                            if (activeEl) activeEl.value = data.name;
                        }

                        modal.hide();
                    } else {
                        errorAlert.textContent = data.error || "An error occurred.";
                        errorAlert.classList.remove('d-none');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    errorAlert.textContent = "A network error occurred.";
                    errorAlert.classList.remove('d-none');
                })
                .finally(() => {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Category';
                });
            });
            
             document.getElementById('newCategoryName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveBtn.click();
                }
            });
        }
    });
</script>
{% endblock %}
