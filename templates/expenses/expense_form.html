{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-lg border-0">
            <div class="card-header fw-bold py-3">
                <div class="d-flex align-items-center">
                    <h4 class="card-title mb-0 h5">
                        {% if object %}{% trans "Edit Expense" %}{% else %}{% trans "New Expense" %}{% endif %}
                    </h4>
                    <button type="button" class="btn btn-outline-primary btn-sm ms-auto" id="header-add-category-btn"
                            title="{% trans 'Add New Category' %}" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                        <i class="bi bi-plus-lg me-1"></i> {% trans "New Category" %}
                    </button>
                </div>
            </div>
            <div class="card-body p-4">
                <form method="post">
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    {% if formset %}
                        {{ formset.management_form }}
                        <div class="table-responsive-xl" style="overflow-y: visible;">
                            <table class="table table-borderless align-top" id="formset-table" data-user-currency="{{ request.user.profile.currency }}">
                                <thead>
                            <tr>
                                <th style="width: 16%;">{% trans "Date" %}</th>
                                <th style="width: 16%;">{% trans "Amount" %}</th>
                                <th style="width: 16%;">{% trans "Currency" %}</th>
                                <th style="width: 16%;">{% trans "Description" %}</th>
                                <th style="width: 16%;">{% trans "Category" %}</th>
                                <th style="width: 16%;">{% trans "Payment method" %}</th>
                                <th style="width: 4%;"></th>
                            </tr>
                        </thead>
                                <tbody id="formset-container">
                                    {% for form in formset %}
                                    <tr class="form-row">
                                        <td class="p-1">
                                            {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                                            <input type="date" name="{{ form.date.html_name }}" class="form-control" 
                                                value="{{ form.date.value|date:'Y-m-d'|default:form.date.value }}" required id="{{ form.date.id_for_label }}">
                                            {% if form.date.errors %}<div class="text-danger small" style="font-size: 0.7rem;">{{ form.date.errors.0 }}</div>{% endif %}
                                        </td>
                                        <td class="p-1">
                                            <input type="number" name="{{ form.amount.html_name }}" class="form-control" 
                                                value="{{ form.amount.value|default:'' }}" required id="{{ form.amount.id_for_label }}" step="0.01" placeholder="{% trans 'Amount' %}">
                                            {% if form.amount.errors %}<div class="text-danger small" style="font-size: 0.7rem;">{{ form.amount.errors.0 }}</div>{% endif %}
                                        </td>
                                        <td class="p-1">
                                            {{ form.currency }}
                                            {% if form.currency.errors %}<div class="text-danger small" style="font-size: 0.7rem;">{{ form.currency.errors.0 }}</div>{% endif %}
                                        </td>
                                        <td class="p-1">
                                            <input type="text" name="{{ form.description.html_name }}" class="form-control" 
                                                value="{{ form.description.value|default:'' }}" id="{{ form.description.id_for_label }}" placeholder="{% trans 'Description' %}">
                                            {% if form.description.errors %}<div class="text-danger small" style="font-size: 0.7rem;">{{ form.description.errors.0 }}</div>{% endif %}
                                        </td>
                                        <td class="p-1">
                                            {{ form.category }}
                                            {% if form.category.errors %}<div class="text-danger small" style="font-size: 0.7rem;">{{ form.category.errors.0 }}</div>{% endif %}
                                        </td>
                                        <td class="p-1">
                                            {{ form.payment_method }}
                                            {% if form.payment_method.errors %}<div class="text-danger small" style="font-size: 0.7rem;">{{ form.payment_method.errors.0 }}</div>{% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if form.instance.pk %}
                                                <div class="d-none">{{ form.DELETE }}</div>
                                                <button type="button" class="btn btn-sm btn-link text-danger p-0 delete-row" 
                                                        title="Delete existing expense">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-sm btn-link text-danger p-0 remove-row" 
                                                        title="Remove row">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary mb-3" id="add-form">
                            <i class="bi bi-plus-lg me-1"></i> {% trans "Add Row" %}
                        </button>
                    
                    {% else %}
                    
                        <div class="mb-3">
                            <label class="form-label text-muted">{{ form.date.label }}</label>
                            <input type="date" name="{{ form.date.name }}" class="form-control" 
                                value="{{ form.date.value|date:'Y-m-d'|default:form.date.value }}" required>
                            {% if form.date.errors %}<div class="text-danger small mt-1">{{ form.date.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">{{ form.amount.label }}</label>
                            <input type="number" name="{{ form.amount.name }}" class="form-control" 
                                value="{{ form.amount.value|default:'' }}" required step="0.01">
                            {% if form.amount.errors %}<div class="text-danger small mt-1">{{ form.amount.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">{{ form.currency.label }}</label>
                            {{ form.currency }}
                            {% if form.currency.errors %}<div class="text-danger small mt-1">{{ form.currency.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">{{ form.description.label }}</label>
                            <input type="text" name="{{ form.description.name }}" class="form-control" 
                                value="{{ form.description.value|default:'' }}">
                            {% if form.description.errors %}<div class="text-danger small mt-1">{{ form.description.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">{{ form.category.label }}</label>
                            {{ form.category }}
                            {% if form.category.errors %}<div class="text-danger small mt-1">{{ form.category.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted">{{ form.payment_method.label }}</label>
                            {{ form.payment_method }}
                            {% if form.payment_method.errors %}<div class="text-danger small mt-1">{{ form.payment_method.errors.0 }}</div>{% endif %}
                        </div>

                    {% endif %}

                </button>

                <div class="d-flex justify-content-start gap-2 mt-4">
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="bi bi-check-lg me-1"></i> {% trans "Save All Expenses" %}
                    </button>
                    
                    <input type="hidden" name="next" value="{{ next_url }}">
                    <a href="{% if next_url %}{{ next_url }}{% else %}{% url 'expense-list' %}{% endif %}" class="btn btn-outline-secondary px-4">{% trans "Cancel" %}</a>
                </div>
                </form>
            </div>
        </div>
    </div>
</div>
    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">{% trans "Add New Category" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="quickAddCategoryForm">
                    <div class="mb-3">
                        <label for="id_new_category_name" class="form-label">{% trans "Category Name" %}</label>
                        <input type="text" class="form-control" id="id_new_category_name" required>
                    </div>
                    <div id="categoryError" class="alert alert-danger d-none mt-2"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-primary" id="saveQuickCategory">{% trans "Save Category" %}</button>
            </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addBtn = document.getElementById('add-form');
        const container = document.getElementById('formset-container');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');

        // Add Row
        if (addBtn) {
            addBtn.addEventListener('click', function() {
                const currentFormCount = parseInt(totalForms.value);
                const forms = container.getElementsByClassName('form-row');
                
                // Clone the first row as a template if no rows exist (edge case), 
                // but typically we clone the last one. If we deleted all, implementation gets tricky, 
                // so we won't allow deleting the last new row if it's the only one, or we keep a hidden template.
                // For simplicity, we assume there's always at least one row or we use the last visible one.
                
                let templateRow = forms[forms.length - 1];
                let newForm = templateRow.cloneNode(true);
                
                // Regex to replace numbers in name/id
                const regex = new RegExp(`form-(\\d+)-`, 'g');
                newForm.innerHTML = newForm.innerHTML.replace(regex, `form-${currentFormCount}-`);
                
                // Cleanup cloned Multiselect UI from the new row
                // The clone includes the generated button-group and hidden select. We need to revert to a clean select.
                const categoryCell = newForm.querySelector('td:nth-child(5)'); // Category is 5th column
                if (categoryCell) {
                    // Remove the generated btn-group
                    const btnGroup = categoryCell.querySelector('.btn-group');
                    if (btnGroup) btnGroup.remove();
                    
                    // Reset the select element
                    const select = categoryCell.querySelector('select');
                    if (select) {
                        select.style.display = ''; // Unhide
                        // Remove any multiselect references/data if jQuery attached them (cloneNode doesn't copy event listeners but might copy some attributes)
                        // Actually, we just need to re-init.
                    }
                }

                const userCurrency = document.getElementById('formset-table').dataset.userCurrency;
                const inputs = newForm.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.name.includes('date')) {
                        input.value = new Date().toISOString().split('T')[0];
                    } else if (input.name.includes('currency')) {
                        input.value = userCurrency;
                    } else {
                        input.value = '';
                    }
                    input.classList.remove('is-invalid');
                    if(input.type === 'checkbox' || input.type === 'radio') input.checked = false;
                });
                
                // Reset text content of non-inputs if any
                newForm.querySelectorAll('.text-danger').forEach(el => el.remove());

                // Change delete button to remove button
                const actionCell = newForm.querySelector('td.text-center');
                actionCell.innerHTML = `
                    <button type="button" class="btn btn-sm btn-link text-danger p-0 remove-row" title="Remove row">
                        <i class="bi bi-x-circle"></i>
                    </button>
                `;

                container.appendChild(newForm);
                totalForms.value = currentFormCount + 1;

                // Re-init multiselect for the new row
                if (categoryCell) {
                    const newSelect = categoryCell.querySelector('select');
                    if (newSelect && $(newSelect).hasClass('django-multi-select')) {
                         // Check size
                         const isSmall = $(newSelect).hasClass('form-select-sm') || $(newSelect).hasClass('form-control-sm');
                         const sizeClass = isSmall ? 'form-select-sm' : '';

                         $(newSelect).multiselect({
                            buttonWidth: '100%',
                            nonSelectedText: "{% trans 'Select...' %}",
                            nSelectedText: " {% trans '- Selected' %}",
                            allSelectedText: "{% trans 'All Selected' %}",
                            numberDisplayed: 1,
                            includeSelectAllOption: true,
                            enableFiltering: true,
                            enableCaseInsensitiveFiltering: true,
                            filterPlaceholder: "{% trans 'Search...' %}",
                            buttonClass: `form-select multiselect-btn ${sizeClass} text-start`,
                            inheritClass: false,
                            templates: {
                                button: '<button type="button" class="multiselect dropdown-toggle" data-bs-toggle="dropdown" data-bs-boundary="viewport"><span class="multiselect-selected-text"></span></button>',
                                option: '<div class="multiselect-option" style="padding: 0.25rem 0.25rem 0.25rem 0.75rem; cursor: pointer;"></div>'
                            },
                             onInitialized: function(select, container) {
                                const button = container.find('button');
                                button.removeClass('btn btn-default btn-outline-secondary');
                                button.addClass('form-select multiselect-btn');
                                if (isSmall) button.addClass('form-select-sm');
                                
                                // Fix for options having icons
                                container.find('input').removeClass('form-select');
                            }
                        });
                    }
                }
            });
        }

        // Delegate click for remove/delete
        container.addEventListener('click', function(e) {
            // Handle Remove (New Row)
            if (e.target.closest('.remove-row')) {
                const row = e.target.closest('tr');
                row.remove();
                updateFormIndices();
            }
            
            // Handle Delete (Existing Row)
            if (e.target.closest('.delete-row')) {
                const row = e.target.closest('tr');
                const deleteInput = row.querySelector('input[name$="-DELETE"]');
                if (deleteInput) {
                    deleteInput.checked = true;
                    row.style.display = 'none';
                    // We don't verify fields on hidden rows, but good execution would require bypassing required attrs.
                    // However, standard browser form submission might block if hidden inputs are required. 
                    // Django forms usually don't put 'required' on fields if it's conditional, but we rely on browser.
                    // Let's remove 'required' from inputs in this row to avoid submission errors.
                    row.querySelectorAll('input, select').forEach(input => {
                        input.removeAttribute('required');
                    });
                }
            }
        });

        function updateFormIndices() {
            // Re-index all forms to avoid validation errors with ManagementForm
            const rows = container.querySelectorAll('.form-row');
            totalForms.value = rows.length;
            
            rows.forEach((row, index) => {
                // Determine pattern for current row based on its existing content (usually form-N-)
                // But simpler: just replace ANY form-\d+- with form-index- in the attributes we care about.
                
                // Update inputs, selects, textareas
                const inputs = row.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.name) {
                        input.name = input.name.replace(/form-\d+-/, `form-${index}-`);
                    }
                    if (input.id) {
                        input.id = input.id.replace(/form-\d+-/, `form-${index}-`);
                    }
                });

                // Update labels if any (though we use little labels in this table)
                row.querySelectorAll('label').forEach(label => {
                    if (label.htmlFor) {
                        label.htmlFor = label.htmlFor.replace(/form-\d+-/, `form-${index}-`);
                    }
                });
                
                // Update hidden DELETE inputs or other specifics if needed
                // The above generic input handler covers typical django form fields.
            });
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Dynamic Category Logic ---
        const modalEl = document.getElementById('addCategoryModal');
        // Check if modal exists (might not be rendered if not authenticated or other reasons, though unlikely here)
        if (modalEl) {
            const modal = new bootstrap.Modal(modalEl);
            const saveBtn = document.getElementById('saveQuickCategory');
            const errorAlert = document.getElementById('categoryError');
            let activeSelectId = null; 

            // Delegation for + buttons (covers both formset and single form)
            // We attach to document.body to ensure we catch everything, or a common wrapper if available.
            // Header Add Category Button logic
            const headerAddBtn = document.getElementById('header-add-category-btn');
            if (headerAddBtn) {
                headerAddBtn.addEventListener('click', function() {
                    activeSelectId = null; // No specific select focused
                    document.getElementById('quickAddCategoryForm').reset();
                    errorAlert.classList.add('d-none');
                    modal.show();
                    setTimeout(() => document.getElementById('id_new_category_name').focus(), 500);
                });
            }

            saveBtn.addEventListener('click', function() {
                const nameInput = document.getElementById('id_new_category_name');
                const name = nameInput.value.trim();
                
                if (!name) {
                    errorAlert.textContent = "{% trans 'Category name cannot be empty.' %}";
                    errorAlert.classList.remove('d-none');
                    return;
                }

                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> {% trans "Saving..." %}';

                fetch("{% url 'category-create-ajax' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ name: name })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const allSelects = document.querySelectorAll('select[name*="category"]'); // Matches 'category' in name
                        allSelects.forEach(select => {
                            // Check if option exists
                            let exists = false;
                            for (let i = 0; i < select.options.length; i++) {
                                if (select.options[i].value === data.name) {
                                    exists = true;
                                    break;
                                }
                            }
                            if (!exists) {
                                const option = new Option(data.name, data.name);
                                select.add(option);
                            }

                            // Sort options alphabetically
                            const options = Array.from(select.options);
                            options.sort((a, b) => a.text.localeCompare(b.text));
                            select.innerHTML = '';
                            options.forEach(opt => select.add(opt));

                            // Rebuild bootstrap-multiselect to reflect the new option
                            if ($(select).hasClass('django-multi-select')) {
                                $(select).multiselect('rebuild');
                            }
                        });

                        // Auto-select the new category in the active/last row
                        if (activeSelectId) {
                            const activeEl = document.getElementById(activeSelectId);
                            if (activeEl) {
                                activeEl.value = data.name;
                                if ($(activeEl).hasClass('django-multi-select')) {
                                    $(activeEl).multiselect('select', data.name);
                                }
                            }
                        } else {
                            // If no specific row targeted, select in first row's dropdown
                            const firstSelect = document.querySelector('select[name*="category"]');
                            if (firstSelect) {
                                firstSelect.value = data.name;
                                if ($(firstSelect).hasClass('django-multi-select')) {
                                    $(firstSelect).multiselect('select', data.name);
                                }
                            }
                        }

                        modal.hide();
                    } else {
                        errorAlert.textContent = data.error || "{% trans 'An error occurred.' %}";
                        errorAlert.classList.remove('d-none');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    errorAlert.textContent = "{% trans 'A network error occurred.' %}";
                    errorAlert.classList.remove('d-none');
                })
                .finally(() => {
                    saveBtn.disabled = false;
                    saveBtn.textContent = '{% trans "Save Category" %}';
                });
            });
            
             document.getElementById('id_new_category_name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveBtn.click();
                }
            });
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const container = document.getElementById('formset-container') || document.body;
        let debounceTimer;
        container.addEventListener('input', function(e) {
            // Use endsWith matching to support both formsets (form-0-description) and single forms (description)
            if (e.target.matches('input') && e.target.name && e.target.name.endsWith('description')) {
                const descriptionInput = e.target;
                const description = descriptionInput.value.trim();
                
                // Clear any existing timer
                clearTimeout(debounceTimer);
                
                // Set new timer
                debounceTimer = setTimeout(() => {
                    // Find corresponding category select
                    // Usually roughly in same row
                    const row = descriptionInput.closest('.form-row') || descriptionInput.closest('.mb-3').parentNode; 
                    // Note: The non-formset view structure is slightly different (<div class="mb-3">...)
                    
                    let categorySelect = null;
                    if (row && row.classList.contains('form-row')) {
                         categorySelect = row.querySelector('select[name$="-category"]');
                    } else if (descriptionInput.closest('form')) {
                         // For non-formset (UpdateView usually), searching globally or sibling
                         // structure: div.mb-3 > input ... then sibling div.mb-3 > select
                         const form = descriptionInput.closest('form');
                         categorySelect = form.querySelector('select[name="category"]');
                    }
                    
                    if (categorySelect) {
                         // Only predict if no category selected OR current selection is 'Uncategorized'/'Others' (optional refinement)
                         // But user might want overwrite? Let's stick to "if empty or not set" for now 
                         // OR just visuals if we don't want to be annoying.
                         // User requirement: "auto populate".
                         
                         // If user manually selected something, maybe we shouldn't change it? 
                         // Current logic: (!categorySelect.value || categorySelect.value === '') covering empty.
                         // But <select> often defaults to first option (e.g. 'Food').
                         // If default is selected, we might want to override.
                         // Let's assume prediction is helpful.
                         
                         if (description.length > 2) {
                            fetch(`{% url 'predict-category' %}?description=${encodeURIComponent(description)}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.category) {
                                    // Select the option if it exists
                                    let found = false;
                                    for (let i = 0; i < categorySelect.options.length; i++) {
                                        // Compare text or value
                                        const opt = categorySelect.options[i];
                                        if (opt.text.toLowerCase() === data.category.toLowerCase() || 
                                            opt.value.toLowerCase() === data.category.toLowerCase()) {
                                            categorySelect.selectedIndex = i;
                                            found = true;
                                            
                                            // Visual feedback - Flash glow
                                            categorySelect.style.transition = "box-shadow 0.3s ease, border-color 0.3s ease";
                                            categorySelect.classList.add('is-valid'); 
                                            categorySelect.style.borderColor = "#198754";
                                            categorySelect.style.boxShadow = "0 0 0 0.25rem rgba(25, 135, 84, 0.25)";
                                            
                                            setTimeout(() => {
                                                categorySelect.classList.remove('is-valid');
                                                categorySelect.style.borderColor = "";
                                                categorySelect.style.boxShadow = "";
                                            }, 2000);
                                            break;
                                        }
                                    }
                                }
                            })
                            .catch(err => console.log('Prediction failed', err));
                         }
                    }
                }, 800); // 800ms debounce
            }
        });
        
        
        // Prevent form submission on Enter key in input AND select fields
        container.addEventListener('keydown', function(e) {
            // Check if key is Enter
            if (e.key === 'Enter') {
                const target = e.target;
                
                // Block on Inputs (except hidden/submit/reset/button)
                const isInput = target.matches('input') && !['submit', 'reset', 'button', 'hidden'].includes(target.type);
                // Block on Selects
                const isSelect = target.matches('select');
                // Block on Textareas (optional, usually Enter in textarea means new line, so maybe NOT block?)
                // Usually we don't want to submit on Enter in textarea unless it's a chat app.
                // But for Description/Notes, new line is valid. So let's NOT block textareas.
                
                if (isInput || isSelect) {
                    e.preventDefault();
                    console.log('Blocked Enter key submission');
                    
                    // UX Improvement: Move focus to next field instead?
                    // For now, just blocking is the priority.
                    return false;
                }
            }
        });

        // Debugging: Log form submissions to console (invisible to user but verifies logic if we could see logs)
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                // If the submitter is NOT the save button, prevent it?
                // `e.submitter` is the element that triggered the submit (button or form itself if Enter)
                // If triggered by Enter, `submitter` might be null or the first button.
                
                // Chrome/Firefox: if Enter pressed, submitter is usually the first submit button in the form.
                // In this form, it's the "Save Changes" button.
                
                // But we BLOCKED Enter on inputs.
                // So if we are here, it should only be from a CLICK on the button.
                
                console.log('Form submitting...', e.submitter);
            });
        }
    });
</script>

{% endblock %}
