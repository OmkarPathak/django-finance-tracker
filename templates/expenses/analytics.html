{% extends 'base.html' %}
{% load static i18n %}
{% load currency_filters digit_filters %}

{% block title %}{% trans "Analytics" %} - TrackMyRupee{% endblock %}

{% block content %}
{% if not is_locked %}
<div class="row mb-4 animate__animated animate__fadeIn">
    <div class="col-12 d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
            <h1 class="h3 fw-bold mb-1">{% trans "Analytics & Trends" %}</h1>
            <p class="text-muted mb-0">{% trans "Visualizing your financial journey over the year." %}</p>
        </div>
        <div>
            <form method="get" class="d-inline-block">
                <div class="input-group input-group-sm shadow-sm" style="width: 130px;">
                    <span class="input-group-text bg-body border-end-0 text-primary"><i class="bi bi-calendar3"></i></span>
                    <select name="year" class="form-select border-start-0 ps-0 fw-bold" onchange="this.form.submit()" style="cursor: pointer;">
                        {% for yr in available_years %}
                            <option value="{{ yr }}" {% if yr == selected_year %}selected{% endif %}>{{ yr }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Financial Health Score Section -->
<div class="row mb-4 animate__animated animate__fadeInUp">
    <div class="col-12">
        <div class="card border-0 shadow-sm health-card-clean position-relative overflow-hidden" style="border-top: 4px solid var(--bs-{{ health_color }}) !important;">
            <style>
                .health-card-clean {
                    background: var(--glass-clean-bg);
                    backdrop-filter: blur(8px);
                    -webkit-backdrop-filter: blur(8px);
                    border: 1px solid var(--glass-clean-border) !important;
                }
                [data-bs-theme="light"] .health-card-clean {
                    --glass-clean-bg: rgba(255, 255, 255, 0.8);
                    --glass-clean-border: rgba(0, 0, 0, 0.04);
                }
                [data-bs-theme="dark"] .health-card-clean {
                    --glass-clean-bg: rgba(33, 37, 41, 0.5);
                    --glass-clean-border: rgba(255, 255, 255, 0.04);
                }
                .health-divider-clean { 
                    border-top: 1px solid rgba(var(--bs-{{ health_color }}-rgb), 0.1); 
                    margin-top: 1rem; 
                    padding-top: 1rem; 
                }
                @media (min-width: 768px) { 
                    .health-divider-clean { 
                        border-top: none; margin-top: 0; padding-top: 0;
                        border-left: 1px solid rgba(var(--bs-{{ health_color }}-rgb), 0.1); 
                        margin-left: 2rem; padding-left: 2rem; 
                    } 
                }
            </style>
            <div class="card-body p-4">
                <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center">
                    <!-- Left: Score & Identifier -->
                    <div class="d-flex align-items-center flex-shrink-0">
                        <div class="bg-{{ health_color }} bg-opacity-10 text-{{ health_color }} rounded-3 me-3 d-flex align-items-center justify-content-center shadow-sm" style="width: 56px; height: 56px;">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor" stroke="none"><style>@keyframes heartbeat-subtle { 0%,100% { transform: scale(1); } 50% { transform: scale(1.08); } } .anim-heart-subtle { animation: heartbeat-subtle 3s ease-in-out infinite; transform-origin: center; }</style><path class="anim-heart-subtle" d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                        </div>
                        <div>
                            <p class="text-uppercase small fw-bold text-muted mb-0 ls-1">{% trans "Health Score" %}</p>
                            <div class="d-flex align-items-baseline gap-2">
                                <h1 class="mb-0 fw-black text-{{ health_color }}">{{ health_score }}<span class="fs-4 fw-medium op-5">/100</span></h1>
                                <span class="badge rounded-pill bg-{{ health_color }} text-white px-3 py-1 small fw-bold">{{ health_label }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right: AI Guidance -->
                    <div class="flex-grow-1 health-divider-clean">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <span class="text-{{ health_color }}"><i class="bi bi-robot"></i></span>
                            <h6 class="fw-bold mb-0 text-dark-emphasis">{% trans "Personalized Insights" %}</h6>
                        </div>
                        <div class="row g-2">
                        {% if insights %}
                            {% for insight in insights %}
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <span class="text-{{ health_color }} me-2 small">‚óè</span>
                                    <p class="mb-0 text-muted small fw-medium">{{ insight }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                             <p class="mb-0 text-muted small">{% trans "Analyze your trends to see insights here." %}</p>
                        {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics Row -->
<div class="row g-4 mb-4 animate__animated animate__fadeInUp">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-muted"><style>@keyframes graph-draw { 0% { stroke-dasharray: 0 30; } 100% { stroke-dasharray: 30 30; } } .anim-graph { animation: graph-draw 3s ease-in-out infinite alternate; }</style><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" class="anim-graph"/><polyline points="17 6 23 6 23 12" class="anim-graph"/></svg>
                    </div>
                    <div>
                        <h6 class="text-muted mb-0">{% trans "Total Income" %} {% if is_current_year %}(YTD){% endif %}</h6>
                    </div>
                </div>
                <h3 class="fw-bold mb-0">
                    {{ user.profile.currency }}{{ total_income_ytd|floatformat:0|translate_digits }}
                </h3>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
         <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-muted"><style>@keyframes cart-roll { 0%,100% { transform: translateX(0); } 50% { transform: translateX(2px); } } .anim-cart { animation: cart-roll 3s ease-in-out infinite; }</style><circle cx="9" cy="21" r="1" class="anim-cart"/><circle cx="20" cy="21" r="1" class="anim-cart"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6" class="anim-cart"/></svg>
                    </div>
                    <div>
                        <h6 class="text-muted mb-0">{% trans "Total Expenses" %} {% if is_current_year %}(YTD){% endif %}</h6>
                    </div>
                </div>
                <h3 class="fw-bold mb-0">
                    {{ user.profile.currency }}{{ total_expense_ytd|floatformat:0|translate_digits }}
                </h3>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
         <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-muted"><style>@keyframes piggy-bob { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-2px); } } .anim-piggy { animation: piggy-bob 3s ease-in-out infinite; }</style><path class="anim-piggy" d="M20 16.5c0 1.4-1.1 2.5-2.5 2.5H6.5C5.1 19 4 17.9 4 16.5v-5C4 10.1 5.1 9 6.5 9H17l3-3v10.5"/><circle class="anim-piggy" cx="16" cy="14" r="1.5"/></svg>
                    </div>
                    <div>
                        <h6 class="text-muted mb-0">{% trans "Avg. Balance Rate" %} {% if is_current_year %}(YTD){% endif %}</h6>
                    </div>
                </div>
                <h3 class="fw-bold mb-0">
                    {{ avg_balance_rate|translate_digits }}%
                </h3>
                 <small class="text-muted">{% trans "Percentage of income kept as balance/savings" %}</small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4 animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
    <!-- Line Chart -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-lg h-100">
            <div class="card-header bg-transparent border-bottom py-3 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="me-2 text-muted" style="vertical-align: -3px;"><style>@keyframes an-vs { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } } .an-vs { animation: an-vs 4s ease-in-out infinite; }</style><rect x="3" y="12" width="4" height="9" rx="1" class="an-vs"/><rect x="10" y="7" width="4" height="14" rx="1" class="an-vs" style="animation-delay:0.2s"/><rect x="17" y="3" width="4" height="18" rx="1" class="an-vs" style="animation-delay:0.4s"/></svg> {% trans "Income vs Expenses" %}</h5>
                <span class="text-muted" data-bs-toggle="tooltip" title="{% trans 'Blue bars show income, Violet bars show expenses. The Teal line is your Net Savings.' %}">
                    <i class="bi bi-question-circle"></i>
                </span>
            </div>
            <div class="card-body">
                <div class="chart-container-scrollable" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                    <div style="height: 350px; min-width: 600px;">
                        <canvas id="balanceChart"></canvas>
                    </div>
                </div>
                 <div class="mt-3 text-center">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i> 
                        {% trans "Comparing what comes in (Blue) vs. what goes out (Violet). The gap is your potential savings." %}
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Donut Chart -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-lg h-100">
            <div class="card-header bg-transparent border-bottom py-3 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="me-2 text-muted" style="vertical-align: -3px;"><style>@keyframes an-donut { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } .an-donut { animation: an-donut 12s linear infinite; transform-origin: center; }</style><circle cx="12" cy="12" r="10" class="an-donut" stroke-dasharray="15 8 8 8"/></svg> {% trans "Spending" %} ({{ selected_year }})</h5>
                 <span class="text-muted" data-bs-toggle="tooltip" title="{% trans 'Breakdown of where your money went this year. The biggest slice is your biggest expense category.' %}">
                    <i class="bi bi-question-circle"></i>
                </span>
            </div>
            <div class="card-body d-flex flex-column align-items-center justify-content-center position-relative">
                <div style="height: 300px; width: 100%;">
                    <canvas id="categoryDonutChart"></canvas>
                </div>
                 <div class="mt-3 text-center">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i> 
                        {% trans "See which categories are consuming the most of your budget this year." %}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Balance Rate Trend -->
<div class="row animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
    <div class="col-12">
        <div class="card border-0 shadow-lg">
             <div class="card-header bg-transparent border-bottom py-3">
                <h5 class="fw-bold mb-0"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="me-2 text-muted" style="vertical-align: -3px;"><style>@keyframes an-line { 0% { stroke-dasharray: 0 40; } 100% { stroke-dasharray: 40 40; } } .an-line { animation: an-line 3s ease-in-out infinite alternate; }</style><polyline points="4 18 8 12 14 16 20 6" class="an-line"/></svg> {% trans "Balance Rate Trend (%)" %}</h5>
            </div>
            <div class="card-body">
                 <div style="height: 300px;">
                    <canvas id="rateChart"></canvas>
                </div>
                <div class="mt-3 text-center">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i> 
                        {% trans "Shows what % of your income is left after expenses. A higher positive percentage means you're growing your wealth." %}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sankey Diagram Section -->
<div class="row animate__animated animate__fadeInUp mt-4" style="animation-delay: 0.25s;">
    <div class="col-12">
        <div class="card border-0 shadow-lg mb-4">
            <div class="card-header bg-transparent border-bottom py-3 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <h5 class="fw-bold mb-0"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="me-2 text-muted" style="vertical-align: -3px;"><style>@keyframes an-flow { 0%,100% { opacity: 0.5; } 50% { opacity: 1; } } .an-flow { animation: an-flow 3s ease-in-out infinite; }</style><path d="M5 5v14" class="an-flow"/><path d="M19 5v14" class="an-flow" style="animation-delay:0.5s"/><path d="M5 12c3-4 8 4 14 0" class="an-flow" style="animation-delay:0.25s"/></svg> {% trans "Income Flow" %}</h5>
                     <span class="text-muted" data-bs-toggle="tooltip" title="{% trans 'Visualizes how your income is distributed across your expenses and savings.' %}">
                        <i class="bi bi-question-circle"></i>
                    </span>
                </div>
            </div>
            <div class="card-body" style="overflow-x: auto;">
                 <div id="sankey_basic" style="width: 100%; min-width: 600px; height: 400px;"></div>
                <div class="mt-3 text-center">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i> 
                        {% trans "Watch your money flow from income to different categories." %}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Day of Week & Recurring Split -->
<div class="row g-4 animate__animated animate__fadeInUp mt-2" style="animation-delay: 0.3s;">
    <div class="col-lg-7">
        <div class="card border-0 shadow-lg h-100">
            <div class="card-header bg-transparent border-bottom py-3">
                <h5 class="fw-bold mb-0"><i class="bi bi-calendar-event me-2 text-muted fs-6" style="vertical-align: -1px;"></i> {% trans "Day-of-Week Spending" %}</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="dowChart"></canvas>
                </div>
                <div class="mt-3 text-center">
                    <small class="text-muted">{% trans "Identifies which days you tend to spend the most." %}</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-5">
        <div class="card border-0 shadow-lg h-100">
            <div class="card-header bg-transparent border-bottom py-3">
                <h5 class="fw-bold mb-0"><i class="bi bi-repeat me-2 text-muted fs-6" style="vertical-align: -1px;"></i> {% trans "Recurring vs One-time" %}</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="recurringSplitChart"></canvas>
                </div>
                <div class="mt-3 text-center">
                    <small class="text-muted">{% trans "Fixed costs vs discretionary spending this month." %}</small>
                </div>
            </div>
        </div>
    </div>
</div>

{% if burn_down_spent %}
<!-- Cumulative Burn-down -->
<div class="row animate__animated animate__fadeInUp mt-4 mb-4" style="animation-delay: 0.4s;">
    <div class="col-12">
        <div class="card border-0 shadow-lg">
            <div class="card-header bg-transparent border-bottom py-3">
                <h5 class="fw-bold mb-0"><i class="bi bi-graph-down-arrow me-2 text-muted fs-6" style="vertical-align: -1px;"></i> {% trans "Cumulative Spending Burn-down" %}</h5>
            </div>
            <div class="card-body">
                <div style="height: 350px;">
                    <canvas id="burnDownChart"></canvas>
                </div>
                <div class="mt-3 text-center">
                    <small class="text-muted">{% trans "Pace of spending through the month vs. your total budget limit." %}</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Data Passing -->
{{ chart_labels|json_script:"chart-labels" }}
{{ income_data|json_script:"income-data" }}
{{ expense_data|json_script:"expense-data" }}
{{ balance_rate_data|json_script:"balance-rate-data" }}
{{ cat_labels|json_script:"cat-labels" }}
{{ cat_data|json_script:"cat-data" }}

{{ sankey_data|json_script:"sankey-data" }}
{{ dow_labels|json_script:"dow-labels" }}
{{ dow_data|json_script:"dow-data" }}

{{ recurring_split_labels|json_script:"recurring-split-labels" }}
{{ recurring_split_data|json_script:"recurring-split-data" }}
{{ burn_down_labels|json_script:"burn-down-labels" }}
{{ burn_down_spent|json_script:"burn-down-spent" }}
{{ burn_down_budget|json_script:"burn-down-budget" }}

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
  google.charts.load("current", {packages:["sankey"]});
  google.charts.setOnLoadCallback(drawSankeyChart);
  function drawSankeyChart() {
    const rawSankeyData = JSON.parse(document.getElementById('sankey-data').textContent);
    
    if (!rawSankeyData || rawSankeyData.length === 0) {
        document.getElementById('sankey_basic').innerHTML = '<p class="text-center text-muted mt-5" style="padding-top: 150px;">{% trans "Not enough data to map flow." %}</p>';
        return;
    }

    var data = new google.visualization.DataTable();
    data.addColumn('string', 'From');
    data.addColumn('string', 'To');
    data.addColumn('number', 'Amount');
    data.addRows(rawSankeyData);

    const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
    const textColor = isDark ? '#f8f9fa' : '#212529';

    var options = {
      sankey: {
        node: {
          label: { color: textColor, fontName: 'Outfit', fontSize: 14, bold: true },
          nodePadding: 30,
          colors: ['#0072ff', '#38f9d7', '#a78bfa', '#00f2fe', '#43e97b', '#f97316', '#6366f1', '#0dcaf0', '#7c3aed', '#94a3b8']
        },
        link: {
          colorMode: 'gradient',
          colors: ['#0072ff', '#38f9d7', '#a78bfa', '#00f2fe', '#43e97b', '#f97316', '#6366f1', '#0dcaf0', '#7c3aed', '#94a3b8']
        }
      }
    };

    var chart = new google.visualization.Sankey(document.getElementById('sankey_basic'));
    chart.draw(data, options);
  }

  // Redraw chart on window resize or theme change
  window.addEventListener('resize', function() {
      const container = document.getElementById('sankey_basic');
      if (container && container.innerHTML !== '') {
          drawSankeyChart();
      }
  });

  // Watch for theme changes and redraw
  const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
              drawSankeyChart();
          }
      });
  });
  observer.observe(document.documentElement, { attributes: true });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const labels = JSON.parse(document.getElementById('chart-labels').textContent);
        const incomeData = JSON.parse(document.getElementById('income-data').textContent);
        const expenseData = JSON.parse(document.getElementById('expense-data').textContent);
        const rateData = JSON.parse(document.getElementById('balance-rate-data').textContent);
        const catLabels = JSON.parse(document.getElementById('cat-labels').textContent);
        const catData = JSON.parse(document.getElementById('cat-data').textContent);

        // --- Common Config ---
        Chart.defaults.font.family = "'Outfit', sans-serif";
        const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        Chart.defaults.color = isDark ? '#adb5bd' : '#6c757d';
        const gridColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';


        // --- Custom Plugin to Draw Values on Charts ---
        const drawValuesPlugin = {
            id: 'drawValues',
            afterDatasetsDraw(chart, args, options) {
                const { ctx } = chart;
                ctx.save();
                
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    if (meta.hidden) return;

                    meta.data.forEach((element, index) => {
                        // Skip if value is 0 or null to avoid clutter
                        const value = dataset.data[index];
                        if (value === 0 || value === null) return;

                        let text = value.toString();
                        // Formatting
                        if (chart.config.type === 'line' || dataset.label.includes('Rate')) {
                             text += '%';
                        } else {
                             // Currency for others (approx) - can just show number
                             text = value.toLocaleString(); 
                        }
                        text = translateDigits(text);

                        ctx.font = 'bold 10px "Outfit", sans-serif';
                        ctx.fillStyle = isDark ? '#adb5bd' : '#6c757d';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';

                        // Position check
                        let x = element.x;
                        let y = element.y - 5; // shift up

                        // For Bar chart, if value is negative or small, adjust (assuming positive here mostly)
                        ctx.fillText(text, x, y);
                    });
                });
                ctx.restore();
            }
        };

        // 1. Balance Chart (Line/Bar Combo)
        const ctxBalance = document.getElementById('balanceChart').getContext('2d');
        new Chart(ctxBalance, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '{% trans "Income" %}',
                        data: incomeData,
                        backgroundColor: 'rgba(0, 114, 255, 0.8)',
                        borderColor: '#0072ff',
                        borderWidth: 1,
                        borderRadius: 4,
                        order: 2,
                        barPercentage: 0.8,
                        categoryPercentage: 0.9
                    },
                    {
                        label: '{% trans "Expense" %}',
                        data: expenseData,
                        backgroundColor: 'rgba(167, 139, 250, 0.8)',
                        borderColor: '#7c3aed',
                        borderWidth: 1,
                        borderRadius: 4,
                        order: 3,
                        barPercentage: 0.8,
                        categoryPercentage: 0.9
                    },
                    {
                        type: 'line',
                        label: '{% trans "Net Balance" %}',
                        data: incomeData.map((inc, i) => inc - expenseData[i]),
                        borderColor: '#38f9d7',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 3,
                        fill: false,
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                         grid: { color: gridColor }
                    },
                    x: {
                         grid: { display: false }
                    }
                }
            }
        });

        // 2. Spending Donut
        const ctxDonut = document.getElementById('categoryDonutChart').getContext('2d');
        // Generate nice colors (matching other charts)
        const bgColors = [
            'rgba(0, 114, 255, 0.6)', // Blue (matches bar chart)
            '#38f9d7',           // Teal
            '#a78bfa',           // Soft Violet
            '#00f2fe',           // Cyan
            '#43e97b',           // Green
            '#f97316',           // Orange
            '#6366f1'            // Indigo
        ];
        
        // Enhance labels with values and percentages for the Legend
        const totalSpending = catData.reduce((acc, curr) => acc + curr, 0);
        const donutLabelsWithValues = catLabels.map((label, i) => {
            const val = catData[i];
            const percent = totalSpending > 0 ? ((val / totalSpending) * 100).toFixed(1) + '%' : '0%';
            return `${label} (${translateDigits(val.toLocaleString())} | ${translateDigits(percent)})`;
        });
        
        // --- Custom Plugin for Donut Percentages ---
        const drawDonutValuesPlugin = {
            id: 'drawDonutValues',
            afterDatasetsDraw(chart, args, options) {
                const { ctx } = chart;
                ctx.save();
                
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    if (meta.hidden) return;
                    
                    const total = dataset.data.reduce((acc, curr) => acc + curr, 0);

                    meta.data.forEach((element, index) => {
                         const value = dataset.data[index];
                         if (value === 0 || total === 0) return;
                         
                         const percentage = (value / total);
                         // Only show text if slice is > 5% to avoid overlap
                         if (percentage < 0.05) return;
                         
                         const text = translateDigits((percentage * 100).toFixed(0)) + '%';
                         
                         // Calculate position (centroid of arc)
                         const { x, y } = element.tooltipPosition();

                         ctx.font = 'bold 11px "Outfit", sans-serif';
                         ctx.fillStyle = '#fff'; 
                         ctx.textAlign = 'center';
                         ctx.textBaseline = 'middle';
                         
                         // Shadow for readability on light/similar colors
                         ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                         ctx.shadowBlur = 3;
                         
                         ctx.fillText(text, x, y);
                         
                         ctx.shadowColor = 'transparent';
                    });
                });
                ctx.restore();
            }
        };
        
        new Chart(ctxDonut, {
            type: 'doughnut',
            data: {
                labels: donutLabelsWithValues,
                datasets: [{
                    data: catData,
                    backgroundColor: bgColors.slice(0, catLabels.length),
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 10 } }
                }
            },
            plugins: [drawDonutValuesPlugin]
        });
        
        // 3. Rate Chart (Line)
        const ctxRate = document.getElementById('rateChart').getContext('2d');
        const gradientRate = ctxRate.createLinearGradient(0, 0, 0, 400);
        gradientRate.addColorStop(0, 'rgba(13, 202, 240, 0.7)');
        gradientRate.addColorStop(1, 'rgba(13, 202, 240, 0.0)');

        new Chart(ctxRate, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '{% trans "Balance Rate (%)" %}',
                    data: rateData,
                    borderColor: '#0dcaf0',
                    backgroundColor: gradientRate,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#0dcaf0',
                    pointHoverRadius: 6
                }]
            },
             options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { 
                        callbacks: {
                            label: function(context) {
                                 return translateDigits(context.parsed.y) + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100, // Usually percentage doesn't go above 100 unless weird
                        grid: { color: gridColor },
                        ticks: { display: false } // Hide Y axis labels
                    },
                    x: {
                         grid: { display: false }
                    }
                }
            },
            plugins: [drawValuesPlugin]
        });

        // 5. Day-of-Week Chart (Bar)
        const dowLabels = JSON.parse(document.getElementById('dow-labels').textContent);
        const dowData = JSON.parse(document.getElementById('dow-data').textContent);
        const ctxDow = document.getElementById('dowChart').getContext('2d');
        
        new Chart(ctxDow, {
            type: 'bar',
            data: {
                labels: dowLabels,
                datasets: [{
                    label: '{% trans "Total Spend" %}',
                    data: dowData,
                    backgroundColor: 'rgba(56, 249, 215, 0.85)',
                    borderColor: '#38f9d7',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: gridColor } },
                    x: { grid: { display: false } }
                }
            },
            plugins: [drawValuesPlugin]
        });

        // 6. Recurring Split Donut
        const recLabels = JSON.parse(document.getElementById('recurring-split-labels').textContent);
        const recData = JSON.parse(document.getElementById('recurring-split-data').textContent);
        const ctxRec = document.getElementById('recurringSplitChart').getContext('2d');
        
        new Chart(ctxRec, {
            type: 'doughnut',
            data: {
                labels: recLabels,
                datasets: [{
                    data: recData,
                    backgroundColor: ['#6366f1', '#38f9d7'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 10 } }
                }
            }
        });

        // 8. Cumulative Burn-down (Line)
        const burnLabels = JSON.parse(document.getElementById('burn-down-labels').textContent);
        const burnSpent = JSON.parse(document.getElementById('burn-down-spent').textContent);
        const burnBudget = JSON.parse(document.getElementById('burn-down-budget').textContent);
        
        if (burnSpent && burnSpent.length > 0) {
            const ctxBurn = document.getElementById('burnDownChart').getContext('2d');
            new Chart(ctxBurn, {
                type: 'line',
                data: {
                    labels: burnLabels,
                    datasets: [
                        {
                            label: '{% trans "Cumulative Spent" %}',
                            data: burnSpent,
                            borderColor: '#7c3aed',
                            backgroundColor: 'rgba(124, 58, 237, 0.1)',
                            fill: true,
                            tension: 0.2,
                            pointRadius: 2
                        },
                        {
                            label: '{% trans "Ideal Budget Line" %}',
                            data: burnBudget,
                            borderColor: '#38f9d7',
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: gridColor } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // Init Tooltips (Added for Contextual Help)
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

    });
</script>

</style>
{% else %}
    <!-- Locked Content State -->
    <div class="row align-items-center justify-content-center animate__animated animate__fadeIn" style="min-height: 60vh;">
        <div class="col-md-8 text-center">
             <div class="mb-4">
                <div class="feature-icon-box bg-warning bg-opacity-10 text-warning mx-auto mb-4" style="width: 100px; height: 100px; font-size: 3rem; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" stroke="none" class="text-warning"><style>@keyframes lock-shake { 0%,100% { transform: rotate(0); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } } .anim-lock { animation: lock-shake 3s ease-in-out infinite; transform-origin: center; }</style><rect x="3" y="11" width="18" height="11" rx="2" class="anim-lock"/><path d="M7 11V7a5 5 0 0110 0v4" fill="none" stroke="currentColor" stroke-width="2" class="anim-lock"/></svg>
                </div>
                <h1 class="fw-bold mb-3">{% trans "Analytics is a Pro Feature" %}</h1>
                <p class="lead text-muted mb-4">
                    {% trans "Unlock detailed insights, cashflow forecasting, and monthly trends with a Pro subscription." %}
                </p>
                <div class="d-grid gap-3 d-sm-flex justify-content-sm-center">
                    <button type="button" class="btn btn-primary btn-lg rounded-pill px-5 shadow-sm" data-bs-toggle="modal" data-bs-target="#comparePlansModal">
                        {% trans "Upgrade to Pro" %}
                    </button>
                    <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-lg rounded-pill px-5">
                        {% trans "Go Back" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Include the Compare Plans Modal -->
    {% include "components/compare_plans_modal.html" %}

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Init Tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
              return new bootstrap.Tooltip(tooltipTriggerEl)
            })

            var myModal = new bootstrap.Modal(document.getElementById('comparePlansModal'), {
                backdrop: 'static',
                keyboard: false
            });
            myModal.show();
        });
    </script>
{% endif %}
{% endblock %}
