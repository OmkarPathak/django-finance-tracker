{% extends "account/base.html" %}

{% load i18n %}
{% load account %}

{% block head_title %}{% trans "Verify Your E-mail Address" %}{% endblock %}

{% block content %}
<div class="row justify-content-center fade-in">
    <div class="col-md-6 col-lg-5">
        <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="card-body p-5 text-center">
                <div class="mb-4">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                        <i class="bi bi-envelope-check-fill text-primary" style="font-size: 2.5rem;"></i>
                    </div>
                </div>
                
                <h2 class="fw-bold mb-3">Check Your Inbox!</h2>
                
                <p class="text-muted mb-4">
                    We've sent a verification email to: <br>
                    <strong>{{ email|default:"your inbox" }}</strong>
                </p>
                
                <p class="small text-muted mb-5">
                    Please click the link in that email to verify your account and start tracking your finances.
                    The link will expire in 3 days.
                </p>

                <div class="d-grid gap-2">
                    <a href="{% url 'account_login' %}" class="btn btn-outline-primary rounded-pill fw-bold">
                        Back to Login
                    </a>
                </div>
                
                <p class="mt-4 mb-0 small text-muted">
                    Didn't receive the email? <a href="#" id="resend-link" class="text-primary text-decoration-none">Resend Email</a>
                </p>
            </div>
            
            <div class="card-footer bg-light border-0 py-3 text-center">
                <small class="text-muted">Need help? <a href="{% url 'contact' %}" class="text-secondary">Contact Support</a></small>
            </div>
        </div>
    </div>
</div>

<!-- Manual Email Entry Modal -->
<div class="modal fade" id="emailInputModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Resend Verification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pb-4">
                <p class="text-muted small mb-3">Please enter the email address you signed up with:</p>
                <input type="email" id="manualEmailInput" class="form-control" placeholder="name@example.com">
                <div id="modalError" class="text-danger small mt-2 d-none"></div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmResendBtn" class="btn btn-primary">Send Email</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const resendLink = document.getElementById('resend-link');
        const modalEl = document.getElementById('emailInputModal');
        const modal = new bootstrap.Modal(modalEl);
        const confirmBtn = document.getElementById('confirmResendBtn');
        const emailInput = document.getElementById('manualEmailInput');
        const modalError = document.getElementById('modalError');

        // Helper to send the API request
        async function sendVerificationRequest(email) {
            const originalText = resendLink.textContent;
            resendLink.textContent = "Sending...";
            resendLink.setAttribute('data-sending', 'true');
            resendLink.classList.add('text-muted'); 
            
            try {
                const response = await fetch("{% url 'resend-verification' %}", {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                         'X-CSRFToken': '{{ csrf_token }}'
                     },
                     body: JSON.stringify({ email: email })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resendLink.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i> Sent!';
                    resendLink.classList.remove('text-primary', 'text-muted', 'text-danger');
                    resendLink.classList.add('text-success', 'fw-bold');
                    resendLink.style.pointerEvents = 'none';
                    if (modalEl.classList.contains('show')) modal.hide();
                } else {
                     throw new Error(data.error || "Failed");
                }
            } catch (err) {
                 console.error(err);
                 // If triggered from modal, show error in modal
                 if (modalEl.classList.contains('show')) {
                     modalError.textContent = err.message;
                     modalError.classList.remove('d-none');
                     // Reset link state since we failed
                     resendLink.textContent = originalText;
                     resendLink.setAttribute('data-sending', 'false');
                     resendLink.classList.remove('text-muted');
                 } else {
                     // Triggered directly, but failed (e.g. wrong email inferred)
                     // Fallback to modal!
                     modal.show();
                     modalError.textContent = "Could not identify email completely. Please enter it manually.";
                     modalError.classList.remove('d-none');
                     
                     resendLink.textContent = originalText;
                     resendLink.setAttribute('data-sending', 'false');
                     resendLink.classList.remove('text-muted');
                 }
            }
        }

        resendLink.addEventListener('click', function(e) {
            e.preventDefault();
            if (this.getAttribute('data-sending') === 'true') return;

            let emailToVerify = "{{ email }}";
            
            // Try explicit variable or DOM
            if (!emailToVerify || emailToVerify === "None") {
                 const emailStrong = document.querySelector('.card-body strong');
                 if (emailStrong) {
                     const text = emailStrong.textContent.trim();
                     if (text && text !== "your inbox" && text.includes('@')) {
                         emailToVerify = text;
                     }
                 }
            }

            if (emailToVerify && emailToVerify !== "None" && emailToVerify.includes('@')) {
                sendVerificationRequest(emailToVerify);
            } else {
                // Unknown email -> Open Modal
                emailInput.value = '';
                modalError.classList.add('d-none');
                modal.show();
            }
        });

        confirmBtn.addEventListener('click', function() {
            const email = emailInput.value.trim();
            if (!email) {
                modalError.textContent = "Please enter an email address.";
                modalError.classList.remove('d-none');
                return;
            }
            sendVerificationRequest(email);
        });
    });
</script>
{% endblock %}
