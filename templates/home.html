{% extends 'base.html' %}

{% block content %}
{% if is_new_user %}
<div class="row align-items-center justify-content-center text-center fade-in" style="min-height: 80vh;">
    <div class="col-md-8 col-lg-6">
            <div class="card border-0 shadow-lg bg-body-tertiary p-5 rounded-4" id="hero-card">
                <div class="mb-4">
                    <div class="d-inline-flex p-4 rounded-circle bg-primary bg-opacity-10 mb-3 text-primary">
                        <i class="bi bi-rocket-takeoff-fill display-1"></i>
                    </div>
                </div>
                <script>window.isOnboarding = true;</script>
                <h2 class="fw-bold mb-3 display-6">Welcome to TrackMyRupee!</h2>
                <p class="h5 text-muted mb-5 fw-normal">Your journey to financial freedom starts here. Let's record your first transaction to get the dashboard moving.</p>
                
                <div class="d-flex flex-column flex-sm-row justify-content-center gap-3">
                    <a href="{% url 'income-create' %}" id="hero-income-btn" class="btn btn-success btn-lg px-4 py-3 rounded-pill fw-bold hover-scale shadow-sm">
                        <i class="bi bi-wallet2 me-2"></i> Record Income
                    </a>
                    <a href="{% url 'expense-create' %}" id="hero-expense-btn" class="btn btn-danger btn-lg px-4 py-3 rounded-pill fw-bold hover-scale shadow-sm">
                        <i class="bi bi-cart-plus me-2"></i> Add Expense
                    </a>
                </div>
            
            <p class="mt-4 small text-muted opacity-75">
                <i class="bi bi-info-circle me-1"></i> 
                Tip: Start with your monthly salary or a recent purchase.
            </p>
        </div>
    </div>
</div>
{% else %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3 fade-in" style="position: relative; z-index: 100;">
    <!-- Mobile Header (One Line) -->
    <div class="d-flex d-md-none justify-content-between align-items-center w-100">
        <div class="d-flex align-items-center gap-2">
            {% if prev_month_url %}
                <a href="{{ prev_month_url }}" class="btn btn-sm d-flex align-items-center justify-content-center" title="Previous Month">
                    <i class="bi bi-chevron-left"></i>
                </a>
            {% endif %}
            <h1 class="h3 mb-0 d-flex align-items-center gap-2">
                {% if selected_month and selected_year %}
                    {{ selected_month|slice:":3" }} {{ selected_year }}
                {% elif selected_month %}
                    {{ selected_month }}
                {% else %}
                    Dashboard
                {% endif %}
            </h1>
            {% if next_month_url %}
                <a href="{{ next_month_url }}" class="btn btn-sm d-flex align-items-center justify-content-center" title="Next Month">
                    <i class="bi bi-chevron-right"></i>
                </a>
            {% endif %}
        </div>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-link text-muted p-0" data-bs-toggle="modal" data-bs-target="#savingsMethodModal" title="How it works">
                <i class="bi bi-info-circle fs-5"></i>
            </button>
            <button class="btn btn-link text-decoration-none text-muted p-0 border-0 fs-6" type="button" data-bs-toggle="collapse" data-bs-target="#dashboardFilters" aria-expanded="false" aria-controls="dashboardFilters">
                <i class="bi bi-funnel me-1"></i> Filters
            </button>
        </div>
    </div>

    <!-- Desktop Header -->
    <div class="d-none d-md-flex align-items-center gap-2">
        {% if prev_month_url %}
            <a href="{{ prev_month_url }}" class="btn btn-sm d-flex align-items-center justify-content-center" title="Previous Month">
                <i class="bi bi-chevron-left"></i>
            </a>
        {% endif %}
        
        <h1 class="h2 mb-0">
            {% if selected_month and selected_year %}
                {{ selected_month|slice:":3" }} {{ selected_year }}
            {% elif selected_month %}
                {{ selected_month }}
            {% else %}
                Dashboard
            {% endif %}
        </h1>


        {% if next_month_url %}
            <a href="{{ next_month_url }}" class="btn btn-sm d-flex align-items-center justify-content-center" title="Next Month">
                <i class="bi bi-chevron-right"></i>
            </a>
        {% endif %}

    </div>
    
    <div class="d-none d-md-flex align-items-center gap-2">
        <button class="btn btn-sm btn-link text-muted p-0 me-2" data-bs-toggle="modal" data-bs-target="#savingsMethodModal" title="How it works">
            <i class="bi bi-info-circle fs-5"></i>
        </button>
        
        <!-- Desktop Filter Form (Original, Unwrapped) -->
        <form method="get" class="d-flex gap-2 align-items-center bg-body-tertiary p-2 rounded shadow-sm flex-wrap" id="filter-form" style="position: relative; z-index: 1060;">
            <!-- Date Range -->
            <div class="input-group input-group-sm" style="width: auto;">
                <span class="input-group-text bg-body-tertiary">From</span>
                <input type="date" name="start_date" id="start_date" class="form-control" value="{{ start_date|default:'' }}">
            </div>
            <div class="input-group input-group-sm" style="width: auto;">
                <span class="input-group-text bg-body-tertiary">To</span>
                <input type="date" name="end_date" id="end_date" class="form-control" value="{{ end_date|default:'' }}">
            </div>

            <div style="min-width: 120px;">
                <select name="year" id="year-select" class="form-control form-control-sm django-multi-select" multiple placeholder="Years...">
                    {% for y in years %}
                        <option value="{{ y }}" {% if y|stringformat:"s" in selected_years %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="min-width: 150px;">
                <select name="month" id="month-select" class="form-control form-control-sm django-multi-select" multiple placeholder="Months...">
                    {% for num, name in months_list %}
                        <option value="{{ num }}" {% if num|stringformat:"s" in selected_months %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="min-width: 150px;">
                 <select name="category" id="category-select" class="form-control form-control-sm django-multi-select" multiple placeholder="Categories...">
                    {% for c in all_categories %}
                        <option value="{{ c }}" {% if c in selected_categories %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Apply & Reset -->
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-sm" onclick="showLoader()">
                    <i class="bi bi-filter me-1"></i> Apply
                </button>
                <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-sm" onclick="showLoader()">
                    <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
                </a>
            </div>
        </form>
    </div>
</div>


<!-- Mobile Filter Form (Moved Outside for Smooth Collapse) -->
<div class="collapse d-md-none w-100" id="dashboardFilters">
    <form method="get" class="mb-4 d-flex gap-2 align-items-center bg-body-tertiary p-2 rounded shadow-sm flex-wrap">
        <!-- Date Range -->
        <div class="input-group input-group-sm" style="width: auto;">
            <span class="input-group-text bg-body-tertiary">From</span>
            <input type="date" name="start_date" class="form-control" value="{{ start_date|default:'' }}">
        </div>
        <div class="input-group input-group-sm" style="width: auto;">
            <span class="input-group-text bg-body-tertiary">To</span>
            <input type="date" name="end_date" class="form-control" value="{{ end_date|default:'' }}">
        </div>

        <div style="min-width: 120px;">
            <select name="year" class="form-control form-control-sm django-multi-select" multiple placeholder="Years...">
                {% for y in years %}
                    <option value="{{ y }}" {% if y|stringformat:"s" in selected_years %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="min-width: 150px;">
            <select name="month" class="form-control form-control-sm django-multi-select" multiple placeholder="Months...">
                {% for num, name in months_list %}
                    <option value="{{ num }}" {% if num|stringformat:"s" in selected_months %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="min-width: 150px;">
            <select name="category" class="form-control form-control-sm django-multi-select" multiple placeholder="Categories...">
                {% for c in all_categories %}
                    <option value="{{ c }}" {% if c in selected_categories %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>
        </div>
        <!-- Apply & Reset -->
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary btn-sm" onclick="showLoader()">
                <i class="bi bi-filter me-1"></i> Apply
            </button>
            <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-sm" onclick="showLoader()">
                <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
            </a>
        </div>
    </form>
</div>

<!-- Emotional Insights Section -->
{% if insights %}
<!-- Desktop: Collapsible Insight Bar -->
<div class="d-none d-md-block mb-4 fade-in">
    <div class="card border-0 shadow-lg overflow-hidden">
        <button class="btn btn-card-header w-100 text-start d-flex justify-content-between align-items-center p-3 border-0 bg-body-tertiary" 
                type="button" data-bs-toggle="collapse" data-bs-target="#desktopInsightsCollapse" 
                aria-expanded="false" aria-controls="desktopInsightsCollapse" id="desktopInsightsToggle">
            <div class="d-flex align-items-center">
                <i class="bi bi-lightbulb-fill text-warning me-2 fs-5"></i> 
                <span class="fw-bold h6 mb-0">This Month's Insights</span>
                <span class="badge rounded-pill bg-primary ms-2 opacity-75">{{ insights|length }}</span>
            </div>
            <i class="bi bi-chevron-down transition-transform" id="desktopInsightsIcon"></i>
        </button>
        <div class="collapse" id="desktopInsightsCollapse">
            <div class="card-body p-3 bg-body bg-opacity-50">
                <div class="row g-3">
                    {% for insight in insights %}
                    <div class="col-12">
                        <div class="alert alert-{{ insight.type }} border-0 shadow-sm d-flex align-items-center justify-content-between gap-3 mb-0" role="alert">
                            <div class="d-flex align-items-center gap-3">
                                <div class="p-2 rounded-circle bg-white bg-opacity-25 d-flex align-items-center justify-content-center flex-shrink-0" style="width: 42px; height: 42px;">
                                    <i class="bi bi-{{ insight.icon }} fs-5"></i>
                                </div>
                                <div>
                                    <h6 class="alert-heading fw-bold mb-1 small">{{ insight.title }}</h6>
                                    <p class="mb-0 small opacity-75">{{ insight.message|safe }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mobile: Swipeable Carousel -->
<div class="d-md-none mb-4 fade-in">
    <h6 class="fw-bold mb-2 ps-1 small text-muted text-uppercase ls-1">Insights</h6>
    <div id="mobileInsightsCarousel" class="carousel slide shadow-lg rounded-4 overflow-hidden" data-bs-ride="carousel" data-bs-interval="6000">
        <div class="carousel-inner">
            {% for insight in insights %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                <div class="alert alert-{{ insight.type }} border-0 mb-0 d-flex flex-column justify-content-center p-4 text-center position-relative" style="min-height: 200px;">
                    <div class="mb-3 d-inline-flex p-3 rounded-circle bg-white bg-opacity-25 mx-auto">
                        <i class="bi bi-{{ insight.icon }} display-6"></i>
                    </div>
                    <h5 class="alert-heading fw-bold mb-2">{{ insight.title }}</h5>
                    <p class="mb-0 opacity-85">{{ insight.message|safe }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
        {% if insights|length > 1 %}
        <div class="carousel-indicators position-absolute bottom-0 mb-2">
            {% for insight in insights %}
            <button type="button" data-bs-target="#mobileInsightsCarousel" data-bs-slide-to="{{ forloop.counter0 }}" 
                    class="{% if forloop.first %}active{% endif %} bg-secondary opacity-50" aria-current="true" 
                    style="width: 6px; height: 6px; border-radius: 50%;"></button>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Desktop Collapse Persistance
        const collapseElement = document.getElementById('desktopInsightsCollapse');
        const toggleIcon = document.getElementById('desktopInsightsIcon');
        const storageKey = 'trackmyrupee_insights_expanded';
        
        // 1. Restore State
        const isExpanded = localStorage.getItem(storageKey) === 'true';
        if (isExpanded && collapseElement) {
            collapseElement.classList.add('show');
            if(toggleIcon) toggleIcon.style.transform = 'rotate(180deg)';
            if(document.getElementById('desktopInsightsToggle')) {
                document.getElementById('desktopInsightsToggle').setAttribute('aria-expanded', 'true');
            }
        }

        // 2. Listen for Toggles
        if (collapseElement) {
            collapseElement.addEventListener('show.bs.collapse', function () {
                localStorage.setItem(storageKey, 'true');
                if(toggleIcon) toggleIcon.style.transform = 'rotate(180deg)';
            });
            collapseElement.addEventListener('hide.bs.collapse', function () {
                localStorage.setItem(storageKey, 'false');
                if(toggleIcon) toggleIcon.style.transform = 'rotate(0deg)';
            });
        }
    });
</script>
{% endif %}

<!-- Summary Cards Row -->
<div class="row g-4 mb-4">
    <!-- Total Income -->
    <div class="col-6 col-md-3" id="tour-income-card">
        <a href="{% url 'income-list' %}" class="text-decoration-none">
            <div class="card shadow-lg border-0 h-100 hover-lift fade-in" style="animation-delay: 0.0s">
                <div class="position-absolute top-0 end-0 p-3 opacity-25">
                    <i class="bi bi-box-arrow-up-right"></i>
                </div>
                <div class="card-body">
                    <h5 class="card-title opacity-75 text-body"><i class="bi bi-cash-coin me-2"></i>Total Income</h5>
                    <div class="d-flex flex-wrap align-items-center mb-0 gap-2">
                        <h2 class="display-6 fw-bold mb-0 text-body">{{ currency_symbol }}{{ total_income|floatformat:0 }}</h2>
                        {% if prev_month_data.income_pct is not None %}
                            <span class="badge rounded-pill {% if prev_month_data.income_pct >= 0 %}bg-success{% else %}bg-danger{% endif %}" style="font-size: 0.75rem;" title="vs last month">
                                <i class="bi bi-arrow-{% if prev_month_data.income_pct >= 0 %}up{% else %}down{% endif %}"></i>
                                {{ prev_month_data.income_pct_abs|floatformat:1 }}%
                            </span>
                        {% endif %}
                    </div>
                    <small class="text-muted">
                        {% if start_date %}
                            Custom Range
                        {% elif selected_month and selected_year %}
                            For {{ selected_month }} {{ selected_year }}
                        {% elif selected_year %}
                            For {{ selected_year }}
                        {% else %}
                            All Time
                        {% endif %}
                    </small>
                </div>
            </div>
        </a>
    </div>
    <!-- Total Expenses -->
    <div class="col-6 col-md-3" id="tour-expenses-card">
        <a href="{% url 'expense-list' %}" class="text-decoration-none">
            <div class="card shadow-lg border-0 h-100 hover-lift fade-in" style="animation-delay: 0.1s">
                <div class="position-absolute top-0 end-0 p-3 opacity-25">
                    <i class="bi bi-box-arrow-up-right"></i>
                </div>
                <div class="card-body">
                    <h5 class="card-title opacity-75 text-body"><i class="bi bi-wallet2 me-2"></i>Total Expenses</h5>
                    <div class="d-flex flex-wrap align-items-center mb-0 gap-2">
                        <h2 class="display-6 fw-bold mb-0 text-body">{{ currency_symbol }}{{ total_expenses|floatformat:0 }}</h2>
                        {% if prev_month_data.expense_pct is not None %}
                            <span class="badge rounded-pill {% if prev_month_data.expense_pct > 0 %}bg-danger{% else %}bg-success{% endif %}" style="font-size: 0.75rem;" title="vs last month">
                                <i class="bi bi-arrow-{% if prev_month_data.expense_pct > 0 %}up{% else %}down{% endif %}"></i>
                                {{ prev_month_data.expense_pct_abs|floatformat:1 }}%
                            </span>
                        {% endif %}
                    </div>
                    <small class="text-muted">
                        {% if start_date %}
                            Custom Range
                        {% elif selected_month and selected_year %}
                            For {{ selected_month }} {{ selected_year }}
                        {% elif selected_year %}
                            For {{ selected_year }}
                        {% else %}
                            All Time
                        {% endif %}
                    </small>
                </div>
            </div>
        </a>
    </div>
    
    <!-- Savings -->
    <div class="col-6 col-md-3">
        <div class="card shadow-lg border-0 h-100 hover-lift fade-in" style="animation-delay: 0.2s">
            <div class="card-body">
                <h5 class="card-title opacity-75"><i class="bi bi-piggy-bank me-2"></i>Balance</h5>
                <div class="d-flex flex-wrap align-items-center mb-0 gap-2">
                    <h2 class="display-6 fw-bold mb-0">{{ currency_symbol }}{{ savings|floatformat:0 }}</h2>
                    {% if prev_month_data.savings_pct is not None %}
                        <span class="badge rounded-pill {% if prev_month_data.savings_pct >= 0 %}bg-success{% else %}bg-danger{% endif %}" style="font-size: 0.75rem;" title="vs last month">
                            <i class="bi bi-arrow-{% if prev_month_data.savings_pct >= 0 %}up{% else %}down{% endif %}"></i>
                            {{ prev_month_data.savings_pct_abs|floatformat:1 }}%
                        </span>
                    {% endif %}
                </div>
                <small class="text-muted">
                    {% if start_date %}
                        Custom Range
                    {% elif selected_month and selected_year %}
                        For {{ selected_month }} {{ selected_year }}
                    {% elif selected_year %}
                         For {{ selected_year }}
                    {% else %}
                        All Time
                    {% endif %}
                </small>
            </div>
        </div>
    </div>

    <!-- Top Category (Restored) -->
    <div class="col-6 col-md-3">
        <div class="card shadow-lg border-0 h-100 hover-lift fade-in" style="animation-delay: 0.3s">
            <div class="card-body">
                <h5 class="card-title opacity-75"><i class="bi bi-tags-fill me-2"></i>Top Category</h5>
                {% if top_category %}
                    <h2 class="display-6 fw-bold mb-0">{{ top_category.category }}</h2>
                    <small class="text-muted">{{ currency_symbol }}{{ top_category.total|floatformat:2 }}</small>
                {% else %}
                    <h2 class="display-6 fw-bold mb-0">-</h2>
                    <small class="text-muted">No data</small>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- Income vs Expenses Chart -->
    <div class="col-md-4">
        <div class="card shadow-lg border-0 h-100 hover-lift fade-in" style="animation-delay: 0.3s">
            <div class="card-header bg-transparent border-bottom">
                <span class="fw-bold">Income vs Expenses</span>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center p-4">
                <div class="position-relative" style="height: 180px; width: 180px;">
                    <canvas id="incomeExpensesChart"></canvas>
                    <div class="position-absolute top-50 start-50 translate-middle text-center">
                        <span class="h2 fw-bold mb-0" id="ie-percentage">0%</span>
                    </div>
                </div>
                <div class="ms-5">
                    <h3 class="fw-bold mb-1">Expenses</h3>
                    <p class="text-muted mb-0 h6">
                        <span class="fw-bold text-body-emphasis">{{ currency_symbol }}{{ total_expenses|floatformat:0 }}</span> 
                        of {{ currency_symbol }}{{ total_income|floatformat:0 }} used
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Budget vs Spent List -->
    <div class="col-md-4" id="tour-budget-card">
        <div class="card shadow-lg border-0 h-100 hover-lift fade-in" style="animation-delay: 0.4s">
            <div class="card-header bg-transparent border-bottom">
                <span class="fw-bold">Budget vs Spent</span>
            </div>
            <div class="card-body px-3 pb-4">
                {% if has_any_budget %}
                    <div class="d-flex flex-column gap-1">
                        {% for item in category_limits|slice:":5" %}
                            {% if item.limit %}
                            <div class="category-list-item py-1 px-2 d-flex align-items-center gap-3">
                                <!-- Left: Name -->
                                <div class="d-flex align-items-center gap-2" style="width: 35%; flex-shrink: 0;">
                                    <div class="text-truncate">
                                        <h6 class="mb-0 fw-semibold text-truncate" title="{{ item.name }}">{{ item.name }}</h6>
                                    </div>
                                </div>

                                <!-- Middle: Amount & Progress -->
                                <div class="d-flex flex-column align-items-end flex-grow-1">
                                    <div class="d-flex justify-content-between w-100 mb-1 small">
                                        <span class="fw-bold">{{ currency_symbol }}{{ item.total|floatformat:0 }}</span>
                                        <span class="text-muted">{{ currency_symbol }}{{ item.limit|floatformat:0 }}</span>
                                    </div>
                                    
                                    <div class="progress w-100 progress-thin">
                                        <div class="progress-bar {% if item.used_percent > 90 %}progress-gradient-danger{% elif item.used_percent > 80 %}progress-gradient-warning{% else %}progress-gradient-success{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ item.used_percent }}%" 
                                             aria-valuenow="{{ item.used_percent }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="h-100 d-flex flex-column justify-content-center align-items-center text-center p-3" style="min-height: 250px;">
                        <div class="mb-3 text-primary opacity-50">
                            <i class="bi bi-pie-chart-fill display-4"></i>
                        </div>
                        <h6 class="fw-bold mb-2">No Budgets Set</h6>
                        <p class="small text-muted mb-3">Set limits for your categories to track spending.</p>
                        <a href="{% url 'category-list' %}" class="btn btn-primary btn-sm rounded-pill px-4">Set Budget</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Top 5 Highest Expenses -->
    <div class="col-md-4">
        <div class="card shadow-lg border-0 h-100 hover-lift fade-in" style="animation-delay: 0.5s">
            <div class="card-header bg-transparent border-bottom fw-bold">
                Top 5 Highest Expenses
            </div>
            <div class="card-body">
                <div style="height: 250px; width: 100%;">
                    <canvas id="topExpensesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row g-4 mb-4">
    <!-- Trend Chart (Stacked) -->
    <div class="col-md-8">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-header bg-transparent border-bottom fw-bold d-flex justify-content-between">
                <span>{{ trend_title }} (Stacked by Category)</span>
            </div>
            <div class="card-body">
                <div style="height: 350px; width: 100%;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- Category Chart -->
    <div class="col-md-4">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-header bg-transparent border-bottom fw-bold">
                Category Distribution
            </div>
            <div class="card-body">
                <div style="height: 320px; width: 100%;">
                    <canvas id="categoryChart"></canvas>
                </div>
                {% if not categories %}
                <div class="text-center text-muted mt-5">No data available</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>



<!-- Charts Row 3: Recent Transactions + Category Summary -->
<div class="row g-4 mb-4">
    <!-- Recent Transactions Table -->
    <div class="col-md-6">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-header bg-transparent border-bottom d-flex justify-content-between align-items-center">
                <span class="fw-bold">Recent Transactions</span>
                <a href="{% url 'expense-list' %}" class="btn btn-sm btn-link text-decoration-none fw-bold">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 text-start align-middle">
                        <thead>
                            <tr>
                                <th class="ps-3">Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th class="text-end pe-3">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in recent_transactions %}
                            <tr>
                                <td class="ps-3 text-nowrap small">{{ expense.date|date:"d M" }}</td>
                                <td class="text-truncate" style="max-width: 150px;">{{ expense.description }}</td>
                                <td class="text-nowrap">{{ expense.category }}</td>
                                <td class="text-end pe-3 fw-bold">{{ expense.amount }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-4 text-muted">None</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Summary List -->
    <div class="col-md-6">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-header bg-transparent border-bottom d-flex justify-content-between align-items-center">
                <span class="fw-bold mb-0">Top Categories</span>
                <a href="{% url 'expense-list' %}" class="btn btn-sm btn-link text-decoration-none fw-bold">View All</a>
            </div>
            <div class="card-body px-3 pb-4">
                <div class="d-flex flex-column gap-1">
                    {% for item in category_limits %}
                    <div class="category-list-item py-1 px-2 d-flex align-items-center gap-3">
                        <!-- Left: Name -->
                        <div class="d-flex align-items-center gap-2" style="width: 35%; flex-shrink: 0;">
                            <div class="text-truncate">
                                <h6 class="mb-0 fw-semibold text-truncate" title="{{ item.name }}">{{ item.name }}</h6>
                            </div>
                        </div>

                        <!-- Middle: Amount & Progress -->
                        <div class="d-flex flex-column align-items-end flex-grow-1">
                            <div class="d-flex justify-content-between w-100 mb-1 small">
                                <span class="fw-bold">{{ currency_symbol }}{{ item.total|floatformat:0 }}</span>
                                {% if item.limit %}
                                    <span class="text-muted">{{ currency_symbol }}{{ item.limit|floatformat:0 }}</span>
                                {% endif %}
                            </div>
                            
                            <!-- Progress Bar -->
                            {% if item.limit %}
                            <div class="progress w-100 progress-thin">
                                <div class="progress-bar {% if item.used_percent > 90 %}progress-gradient-danger{% elif item.used_percent > 80 %}progress-gradient-warning{% else %}progress-gradient-success{% endif %}" 
                                     role="progressbar" 
                                     style="width: {{ item.used_percent }}%" 
                                     aria-valuenow="{{ item.used_percent }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100"></div>
                            </div>
                            {% else %}
                            <!-- No limit set -> Just a full bar or different visual -->
                            <!-- No limit set -> Use Info color -->
                            <div class="progress w-100 progress-thin">
                                <div class="progress-bar progress-gradient-info" 
                                     role="progressbar" 
                                     style="width: 100%; opacity: 0.5;" 
                                     title="No limit set"></div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-inbox fs-1 d-block mb-3 opacity-50"></i>
                        No expense data available
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'partials/savings_modal.html' %}
{% endif %}

{{ categories|json_script:"categories-data" }}
{{ category_amounts|json_script:"category-amounts-data" }}
{{ trend_labels|json_script:"trend-labels" }}
{{ trend_datasets|json_script:"trend-datasets" }}
{{ top_labels|json_script:"top-labels" }}
{{ top_amounts|json_script:"top-amounts" }}
{{ category_limits|json_script:"category-limits-data" }}

<script>
    function showLoader() {
        document.getElementById('page-loader').classList.remove('d-none');
        document.getElementById('page-loader').classList.add('d-flex');
    }

    function showLoaderAndSubmit() {
        showLoader();
        document.getElementById('filter-form').submit();
    }

    document.addEventListener('DOMContentLoaded', function() {
        {% if is_new_user %} return; {% endif %}

        // --- Data ---
        const categories = JSON.parse(document.getElementById('categories-data').textContent);
        const categoryAmounts = JSON.parse(document.getElementById('category-amounts-data').textContent);
        const trendLabels = JSON.parse(document.getElementById('trend-labels').textContent);
        const trendDatasets = JSON.parse(document.getElementById('trend-datasets').textContent);
        const topLabels = JSON.parse(document.getElementById('top-labels').textContent);
        const topAmounts = JSON.parse(document.getElementById('top-amounts').textContent);

        // --- Theme handling ---
        const getThemeColor = () => {
            const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
            return {
                text: isDark ? '#adb5bd' : '#6c757d',
                grid: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)',
                remaining: isDark ? '#495057' : '#e9ecef' 
            };
        };

        let currentColors = getThemeColor();
        Chart.defaults.font.family = "'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif";
        Chart.defaults.color = currentColors.text;
        
        const charts = {};

        // --- Gradient Helper ---
        const createGradient = (ctx, colorStart, colorEnd) => {
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, colorStart);
            gradient.addColorStop(1, colorEnd);
            return gradient;
        };

        // --- 0. Income vs Expenses Chart (Donut) ---
        const totalIncome = {{ total_income|stringformat:"f"|default:0 }};
        const totalExpenses = {{ total_expenses|stringformat:"f"|default:0 }};
        let iePercentage = 0;
        const ctxIncome = document.getElementById('incomeExpensesChart').getContext('2d');
        const gradBlue = createGradient(ctxIncome, '#219EBC', '#8ECAE6');
        const gradRed = createGradient(ctxIncome, '#E74C3C', '#C0392B');
        const gradOrange = createGradient(ctxIncome, '#F39C12', '#F1C40F');

        let chartColor = gradBlue; // Default Blue

        if (totalIncome > 0) {
            iePercentage = Math.round((totalExpenses / totalIncome) * 100);
        } else if (totalExpenses > 0) {
            iePercentage = 100; // No income but expenses exists
        }

        // Set color based on percentage
        if (iePercentage > 100) {
            chartColor = gradRed; // Red if over budget
            document.getElementById('ie-percentage').classList.add('text-danger');
        } else if (iePercentage > 80) {
            chartColor = gradOrange; // Orange warning
        } else {
            document.getElementById('ie-percentage').classList.add('text-primary'); // Blue default
            chartColor = gradBlue; 
        }
        
        document.getElementById('ie-percentage').innerText = iePercentage + '%';
        if (iePercentage > 100) document.getElementById('ie-percentage').innerText = '>100%';

        charts.incomeExpenses = new Chart(ctxIncome, {
            type: 'doughnut',
            data: {
                labels: ['Expenses', 'Remaining'],
                datasets: [{
                    data: [totalExpenses, Math.max(0, totalIncome - totalExpenses)],
                    backgroundColor: [
                        chartColor,
                        currentColors.remaining // Light gray for remaining
                    ],
                    borderWidth: 0,
                    borderRadius: 20,
                    cutout: '85%',   // Thin ring
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false } // Disable tooltip for cleaner look
                },
                animation: {
                    animateScale: true,
                    animateRotate: true
                }
            }
        });

        // --- 1. Trend Chart ---
        const ctxTrend = document.getElementById('trendChart').getContext('2d');
        // Define Gradient Palette (Cohesive: Blues, Teals, Purples)
        const trendGradients = [
            createGradient(ctxTrend, '#00c6ff', '#0072ff'), // Blue
            createGradient(ctxTrend, '#43e97b', '#38f9d7'), // Teal
            createGradient(ctxTrend, '#8E2DE2', '#4A00E0'), // Purple
            createGradient(ctxTrend, '#4facfe', '#00f2fe'), // Cyan
            createGradient(ctxTrend, '#30cfd0', '#330867')  // Sea-Blue
        ];

        // Apply gradients to datasets
        trendDatasets.forEach((ds, i) => {
            ds.backgroundColor = trendGradients[i % trendGradients.length];
            ds.borderRadius = 2;
        });

        charts.trend = new Chart(ctxTrend, {
            type: 'bar',
            data: { labels: trendLabels, datasets: trendDatasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 11 } } } },
                scales: {
                    x: { 
                        stacked: true, 
                        grid: { display: false },
                        ticks: {
                            autoSkip: true,
                            maxRotation: 45,
                            minRotation: 0,
                            font: { size: 11 }
                        }
                    },
                    y: { stacked: true, grid: { color: currentColors.grid }, beginAtZero: true }
                }
            }
        });

        // --- 2. Category Chart ---
        if (categories.length > 0) {
            const ctxCat = document.getElementById('categoryChart').getContext('2d');
            const catGradients = [
                 createGradient(ctxCat, '#00c6ff', '#0072ff'), // Blue
                 createGradient(ctxCat, '#43e97b', '#38f9d7'), // Teal
                 createGradient(ctxCat, '#8E2DE2', '#4A00E0'), // Purple
                 createGradient(ctxCat, '#4facfe', '#00f2fe'), // Cyan
                 createGradient(ctxCat, '#30cfd0', '#330867')  // Sea-Blue
            ];

            charts.category = new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: categoryAmounts,
                        backgroundColor: catGradients,
                        borderWidth: 0
                    }]
                },
                plugins: [{
                    id: 'doughnutLabels',
                    afterDatasetsDraw(chart) {
                        const { ctx } = chart;
                        ctx.save();
                        const meta = chart.getDatasetMeta(0);
                        meta.data.forEach((arc, index) => {
                            const center = arc.getCenterPoint();
                            const value = categoryAmounts[index];
                            const text = '{{ currency_symbol }}' + value.toLocaleString();
                            if (arc.circumference > 0.25) {
                                ctx.font = 'bold 10px sans-serif';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                ctx.fillStyle = '#ffffff';
                                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                                ctx.shadowBlur = 3;
                                ctx.fillText(text, center.x, center.y);
                                ctx.shadowBlur = 0;
                            }
                        });
                        ctx.restore();
                    }
                }],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: {size: 11} } } }
                }
            });
        }

        // --- 3. Top Expenses Chart ---
        const ctxTop = document.getElementById('topExpensesChart').getContext('2d');
        const gradTop = createGradient(ctxTop, '#4facfe', '#00f2fe'); // Cyan-Blue

        charts.topExpenses = new Chart(ctxTop, {
            type: 'bar',
            data: {
                labels: topLabels,
                datasets: [{
                    label: 'Amount',
                    data: topAmounts,
                    backgroundColor: gradTop,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: currentColors.grid } },
                    y: { grid: { display: false } }
                }
            }
        });

        // --- 4. Budget vs Spent Chart ---
        const limitsData = JSON.parse(document.getElementById('category-limits-data').textContent);
        const withLimits = limitsData.filter(item => item.limit !== null && item.limit > 0);
        
        if (withLimits.length > 0) {
            const ctxBudget = document.getElementById('budgetChart').getContext('2d');
            const budgetLabels = withLimits.map(item => item.name);
            const spentData = withLimits.map(item => Math.min((item.total / item.limit) * 100, 100));
            const remainingData = spentData.map(spentPct => 100 - spentPct);
            
            // Dynamic Gradients for Budgets
            const spentColors = withLimits.map(item => {
                if (item.total > item.limit) return createGradient(ctxBudget, '#ed213a', '#93291e'); // Red (Over)
                if (item.total > item.limit * 0.8) return createGradient(ctxBudget, '#f7b733', '#fc4a1a'); // Orange (Warning)
                return createGradient(ctxBudget, '#11998e', '#38ef7d'); // Green (Safe)
            });

            charts.budget = new Chart(ctxBudget, {
                type: 'bar',
                data: {
                    labels: budgetLabels,
                    datasets: [
                        {
                            label: 'Spent',
                            data: spentData,
                            backgroundColor: spentColors,
                            borderRadius: 4,
                        },
                        {
                            label: 'Remaining',
                            data: remainingData,
                            backgroundColor: currentColors.remaining,
                            borderRadius: 4,
                        }
                    ]
                },
                plugins: [{
                    id: 'customLabels',
                    afterDatasetsDraw(chart) {
                        const { ctx, chartArea: { left, width } } = chart;
                        ctx.save();
                        const meta = chart.getDatasetMeta(0);
                        meta.data.forEach((bar, index) => {
                            const item = withLimits[index];
                            const y = bar.y;
                            const x = left + width / 2;
                            const text = `{{ currency_symbol }}${item.total.toLocaleString()} / {{ currency_symbol }}${item.limit.toLocaleString()}`;
                            ctx.font = 'bold 11px sans-serif';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                            ctx.shadowBlur = 3;
                            ctx.fillStyle = '#ffffff';
                            ctx.fillText(text, x, y);
                            ctx.shadowColor = 'transparent';
                            ctx.shadowBlur = 0;
                        });
                        ctx.restore();
                    }
                }],
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (c) => c[0].label,
                                label: (c) => {
                                    const item = withLimits[c.dataIndex];
                                    if (c.dataset.label === 'Spent') return `Spent: {{ currency_symbol }}${item.total.toLocaleString()} (${item.used_percent}%)`;
                                    const remaining = Math.max(0, item.limit - item.total);
                                    return `Remaining: {{ currency_symbol }}${remaining.toLocaleString()}`;
                                },
                                footer: (c) => `Limit: {{ currency_symbol }}${withLimits[c[0].dataIndex].limit.toLocaleString()}`
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, display: false, min: 0, max: 100 },
                        y: { stacked: true, grid: { display: false }, ticks: { font: { weight: 'bold' } } }
                    }
                }
            });
        }

        // --- Theme Change Observer ---
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
                    const newColors = getThemeColor();
                    Chart.defaults.color = newColors.text;
                    
                    // Update Budget Chart remaining color
                    if (charts.budget) {
                        charts.budget.data.datasets[1].backgroundColor = newColors.remaining;
                        charts.budget.update();
                    }
                    
                    // Update Grid Lines for other charts
                    [charts.incomeExpenses, charts.trend, charts.topExpenses].forEach(chart => {
                        if (chart) {
                            if (chart.options.scales.x) chart.options.scales.x.grid.color = newColors.grid;
                            if (chart.options.scales.y) chart.options.scales.y.grid.color = newColors.grid;
                            chart.update();
                        }
                    });
                }
            });
        });

        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['data-bs-theme']
        });
    });
</script>
{% endblock %}