{% extends 'base.html' %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3 fade-in">
    <h1 class="h2 mb-0">Dashboard</h1>
    
    <!-- Filter Form -->
    <form method="get" class="d-flex gap-2 align-items-center bg-body-tertiary p-2 rounded shadow-sm flex-wrap" id="filter-form">
        <!-- Date Range -->
        <div class="input-group input-group-sm" style="width: auto;">
            <span class="input-group-text bg-body-tertiary">From</span>
            <input type="date" name="start_date" id="start_date" class="form-control" value="{{ start_date|default:'' }}" onchange="showLoaderAndSubmit()">
        </div>
        <div class="input-group input-group-sm" style="width: auto;">
            <span class="input-group-text bg-body-tertiary">To</span>
            <input type="date" name="end_date" id="end_date" class="form-control" value="{{ end_date|default:'' }}" onchange="showLoaderAndSubmit()">
        </div>

        <select name="year" class="form-select form-select-sm" style="width: auto;" onchange="showLoaderAndSubmit()">
            <option value="">All Years</option>
            {% for y in years %}
                <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>
        <select name="month" class="form-select form-select-sm" style="width: auto;" onchange="showLoaderAndSubmit()">
            <option value="">All Months</option>
            {% for num, name in months_list %}
                <option value="{{ num }}" {% if selected_month == num %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
        </select>
         <select name="category" class="form-select form-select-sm" style="width: auto;" onchange="showLoaderAndSubmit()">
            <option value="">All Categories</option>
            {% for c in all_categories %}
                <option value="{{ c }}" {% if selected_category == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
        </select>
        <!-- Reset Button -->
        <a href="{% url 'home' %}" class="btn btn-outline-primary btn-sm" onclick="showLoader()">
            <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
        </a>
    </form>
</div>

<!-- Summary Cards Row -->
<div class="row g-4 mb-4">
    <!-- Total Income -->
    <div class="col-md-3">
        <div class="card shadow-lg border-0 h-100 hover-lift fade-in" style="animation-delay: 0.0s">
            <div class="card-body">
                <h5 class="card-title opacity-75"><i class="bi bi-cash-coin me-2"></i>Total Income</h5>
                <h2 class="display-6 fw-bold mb-0">₹{{ total_income|floatformat:0 }}</h2>
                <small class="text-muted">
                    {% if start_date %}
                        Custom Range
                    {% elif selected_month and selected_year %}
                        For {{ selected_month }}/{{ selected_year }}
                    {% elif selected_year %}
                         For {{ selected_year }}
                    {% else %}
                        All Time
                    {% endif %}
                </small>
            </div>
        </div>
    </div>

    <!-- Total Expenses -->
    <div class="col-md-3">
        <div class="card shadow-lg border-0 h-100 hover-lift fade-in" style="animation-delay: 0.1s">
            <div class="card-body">
                <h5 class="card-title opacity-75"><i class="bi bi-wallet2 me-2"></i>Total Expenses</h5>
                <h2 class="display-6 fw-bold mb-0">₹{{ total_expenses|floatformat:0 }}</h2>
                <small class="text-muted">
                    {% if start_date %}
                        Custom Range
                    {% elif selected_month and selected_year %}
                        For {{ selected_month }}/{{ selected_year }}
                    {% elif selected_year %}
                         For {{ selected_year }}
                    {% else %}
                        All Time
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
    
    <!-- Savings -->
    <div class="col-md-3">
        <div class="card shadow-lg border-0 h-100 hover-lift fade-in" style="animation-delay: 0.2s">
            <div class="card-body">
                <h5 class="card-title opacity-75"><i class="bi bi-piggy-bank me-2"></i>Savings</h5>
                <h2 class="display-6 fw-bold mb-0">₹{{ savings|floatformat:0 }}</h2>
                <small class="text-muted">
                    {% if start_date %}
                        Custom Range
                    {% elif selected_month and selected_year %}
                        For {{ selected_month }}/{{ selected_year }}
                    {% elif selected_year %}
                         For {{ selected_year }}
                    {% else %}
                        All Time
                    {% endif %}
                </small>
            </div>
        </div>
    </div>

    <!-- Top Category (Restored) -->
    <div class="col-md-3">
        <div class="card shadow-lg border-0 h-100 hover-lift fade-in" style="animation-delay: 0.3s">
            <div class="card-body">
                <h5 class="card-title opacity-75"><i class="bi bi-tags-fill me-2"></i>Top Category</h5>
                {% if top_category %}
                    <h2 class="display-6 fw-bold mb-0">{{ top_category.category }}</h2>
                    <small class="text-muted">₹{{ top_category.total|floatformat:2 }}</small>
                {% else %}
                    <h2 class="display-6 fw-bold mb-0">-</h2>
                    <small class="text-muted">No data</small>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- Top Category KPI -->
    <!-- <div class="col-md-4">
        <div class="card shadow-lg border-0 h-100 hover-lift fade-in" style="animation-delay: 0.2s">
            <div class="card-body">
                <h5 class="card-title opacity-75"><i class="bi bi-tags-fill me-2"></i>Top Category</h5>
                {% if top_category %}
                    <h2 class="display-6 fw-bold mb-0">{{ top_category.category }}</h2>
                    <small class="opacity-75">₹{{ top_category.total|floatformat:2 }}</small>
                {% else %}
                    <h2 class="display-6 fw-bold mb-0">-</h2>
                    <small class="opacity-75">No data</small>
                {% endif %}
            </div>
        </div>
    </div> -->

    <!-- Income vs Expenses Chart -->
    <div class="col-md-12">
        <div class="card shadow-lg border-0 h-100 hover-lift fade-in" style="animation-delay: 0.3s">
            <div class="card-header bg-transparent fw-bold">
                Income vs Expenses
            </div>
            <div class="card-body">
                <div style="height: 200px;">
                    <canvas id="incomeExpensesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row g-4 mb-4">
    <!-- Trend Chart (Stacked) -->
    <div class="col-md-8">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-header bg-transparent fw-bold d-flex justify-content-between">
                <span>{{ trend_title }} (Stacked by Category)</span>
            </div>
            <div class="card-body">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>
    <!-- Category Chart -->
    <div class="col-md-4">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-header bg-transparent fw-bold">
                Category Distribution
            </div>
            <div class="card-body">
                <canvas id="categoryChart"></canvas>
                {% if not categories %}
                <div class="text-center text-muted mt-5">No data available</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2: Top 5 + Budget -->
<div class="row g-4 mb-4">
    <!-- Top Expenses -->
    <div class="col-md-6">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-header bg-transparent fw-bold">
                Top 5 Highest Expenses
            </div>
            <div class="card-body">
                <canvas id="topExpensesChart" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Budget vs Spent Chart -->
    <div class="col-md-6">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-header bg-transparent fw-bold">
                Budget vs Spent (Categories with Monthly Limits)
            </div>
            <div class="card-body">
                <canvas id="budgetChart" height="200"></canvas>
                {% if not category_limits %}
                <div class="text-center text-muted mt-3">No categories with limits set</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 3: Recent Transactions + Category Summary -->
<div class="row g-4 mb-4">
    <!-- Recent Transactions Table -->
    <div class="col-md-6">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-header bg-transparent fw-bold d-flex justify-content-between align-items-center">
                <span>Recent Transactions</span>
                <a href="{% url 'expense-list' %}" class="btn btn-sm btn-link text-decoration-none">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 text-start align-middle">
                        <thead>
                            <tr>
                                <th class="ps-3">Date</th>
                                <th>Description</th>
                                <th class="text-end pe-3">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in recent_transactions %}
                            <tr>
                                <td class="ps-3 text-nowrap small">{{ expense.date|date:"d M" }}</td>
                                <td class="text-truncate" style="max-width: 150px;">{{ expense.description }}</td>
                                <td class="text-end pe-3 fw-bold">{{ expense.amount }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center py-4 text-muted">None</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Summary Table -->
    <div class="col-md-6">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-header bg-transparent fw-bold">
                Category Summary
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 text-start align-middle">
                        <thead>
                            <tr>
                                <th class="ps-4">Category</th>
                                <th class="text-end pe-4">Total Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in category_data %}
                            <tr>
                                <td class="ps-4">{{ item.category }}</td>
                                <td class="text-end pe-4 fw-bold">₹{{ item.total|floatformat:2 }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2" class="text-center py-4 text-muted">No data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{{ categories|json_script:"categories-data" }}
{{ category_amounts|json_script:"category-amounts-data" }}
{{ trend_labels|json_script:"trend-labels" }}
{{ trend_datasets|json_script:"trend-datasets" }}
{{ top_labels|json_script:"top-labels" }}
{{ top_amounts|json_script:"top-amounts" }}
{{ category_limits|json_script:"category-limits-data" }}

<script>
    function showLoader() {
        document.getElementById('page-loader').classList.remove('d-none');
        document.getElementById('page-loader').classList.add('d-flex');
    }

    function showLoaderAndSubmit() {
        showLoader();
        document.getElementById('filter-form').submit();
    }

    document.addEventListener('DOMContentLoaded', function() {
        // --- Data ---
        const categories = JSON.parse(document.getElementById('categories-data').textContent);
        const categoryAmounts = JSON.parse(document.getElementById('category-amounts-data').textContent);
        const trendLabels = JSON.parse(document.getElementById('trend-labels').textContent);
        const trendDatasets = JSON.parse(document.getElementById('trend-datasets').textContent);
        const topLabels = JSON.parse(document.getElementById('top-labels').textContent);
        const topAmounts = JSON.parse(document.getElementById('top-amounts').textContent);

        Chart.defaults.font.family = "'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif";
        Chart.defaults.color = '#6c757d';

        // --- 0. Income vs Expenses Chart (Single Stacked Horizontal Bar) ---
        const totalIncome = {{ total_income|stringformat:"f"|default:0 }};
        const totalExpenses = {{ total_expenses|stringformat:"f"|default:0 }};
        // If expenses > income, savings is 0 (or negative, but we clip to 0 for chart)
        // If expenses > income, savings is 0 (or negative, but we clip to 0 for chart)
        const savings = Math.max(0, totalIncome - totalExpenses);

        // Custom Plugin to draw text
        const customLabelsPlugin = {
            id: 'customLabels',
            afterDatasetsDraw(chart) {
                const { ctx } = chart;
                ctx.save();
                
                chart.data.datasets.forEach((dataset, i) => {
                    const meta = chart.getDatasetMeta(i);
                    meta.data.forEach((bar, index) => {
                        const value = dataset.data[index];
                        if (value > 0 && totalIncome > 0) {
                            const pct = ((value / totalIncome) * 100).toFixed(0);
                            const text = `₹${value.toLocaleString()} (${pct}%)`;
                            
                            // Position text in center of bar
                            // For horizontal: base is left, x is right (or vice versa)
                            const centerX = (bar.base + bar.x) / 2;
                            const centerY = bar.y;
                            
                            // Check if bar is wide enough 
                            if (Math.abs(bar.base - bar.x) > 40) {
                                ctx.font = 'bold 11px sans-serif';
                                ctx.fillStyle = '#ffffff';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                // Add shadow for better readability
                                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                                ctx.shadowBlur = 2;
                                
                                ctx.fillText(text, centerX, centerY);
                                ctx.shadowBlur = 0;
                            }
                        }
                    });
                });
                ctx.restore();
            }
        };

        new Chart(document.getElementById('incomeExpensesChart'), {
            type: 'bar',
            data: {
                labels: ['Income Distribution'],
                datasets: [
                    {
                        label: 'Expenses',
                        data: [totalExpenses],
                        backgroundColor: '#FB8500', // Orange
                        borderRadius: 4,
                        barThickness: 50 // Slightly thicker
                    },
                    {
                        label: 'Savings',
                        data: [savings],
                        backgroundColor: '#219EBC', // Teal
                        borderRadius: 4,
                        barThickness: 50
                    }
                ]
            },
            plugins: [customLabelsPlugin], // Register the plugin
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: true, position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ₹' + context.raw.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        stacked: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        max: totalIncome > 0 ? totalIncome : 1, // Force max width to Total Income
                    },
                    y: { 
                        stacked: true,
                        grid: { display: false }, 
                        ticks: { display: false } 
                    } 
                }
            }
        });

        // --- 1. Trend Chart (Stacked Bar) ---
        new Chart(document.getElementById('trendChart'), {
            type: 'bar',
            data: {
                labels: trendLabels,
                datasets: trendDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } },
                scales: {
                    x: { 
                        stacked: true,
                        grid: { display: false } 
                    },
                    y: { 
                        stacked: true,
                        grid: { color: 'rgba(0,0,0,0.05)' }, 
                        beginAtZero: true 
                    }
                }
            }
        });

        // --- 2. Category Chart (Doughnut) ---
        if (categories.length > 0) {
            new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: categoryAmounts,
                        backgroundColor: [
                            '#8ECAE6', '#219EBC', '#023047', '#FFB703', '#FB8500'
                        ],
                        borderWidth: 0
                    }]
                },
                plugins: [{
                    id: 'doughnutLabels',
                    afterDatasetsDraw(chart) {
                        const { ctx } = chart;
                        ctx.save();
                        
                        const meta = chart.getDatasetMeta(0);
                        meta.data.forEach((arc, index) => {
                            const center = arc.getCenterPoint();
                            const value = categoryAmounts[index];
                            const text = '₹' + value.toLocaleString();
                            
                            // Only draw if slice is large enough (> 15 degrees approx)
                            if (arc.circumference > 0.25) {
                                ctx.font = 'bold 10px sans-serif';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                ctx.fillStyle = '#ffffff';
                                
                                // Text shadow for better visibility
                                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                                ctx.shadowBlur = 3;
                                
                                ctx.fillText(text, center.x, center.y);
                                ctx.shadowBlur = 0;
                            }
                        });
                        ctx.restore();
                    }
                }],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: {size: 11} } } 
                    }
                }
            });
        }

        // --- 3. Top Expenses Chart (Horizontal Bar) ---
        new Chart(document.getElementById('topExpensesChart'), {
            type: 'bar',
            data: {
                labels: topLabels,
                datasets: [{
                    label: 'Amount',
                    data: topAmounts,
                    backgroundColor: '#FB8500', // Orange
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: 'rgba(0,0,0,0.05)' } },
                    y: { grid: { display: false } }
                }
            }
        });

        // --- 4. Budget vs Spent Chart (Horizontal Stacked Loader Style) ---
        const limitsData = JSON.parse(document.getElementById('category-limits-data').textContent);
        const withLimits = limitsData.filter(item => item.limit !== null && item.limit > 0);
        
        if (withLimits.length > 0) {
            const budgetLabels = withLimits.map(item => item.name);
            
            // Calculate data for "Spent" and "Remaining" as percentages of the limit
            // This ensures every bar is the same total length (100%), acting like a progress bar
            const spentData = withLimits.map(item => {
                const pct = (item.total / item.limit) * 100;
                // Cap at 100% for the visual bar split (if overspent, the whole bar is red)
                return Math.min(pct, 100);
            });
            
            const remainingData = spentData.map(spentPct => 100 - spentPct);
            
            new Chart(document.getElementById('budgetChart'), {
                type: 'bar',
                data: {
                    labels: budgetLabels,
                    datasets: [
                        {
                            label: 'Spent',
                            data: spentData,
                            // If spent > limit (used_percent > 100), show Orange. Else Teal.
                            backgroundColor: withLimits.map(item => item.total > item.limit ? '#FB8500' : '#219EBC'),
                            borderRadius: 4,
                        },
                        {
                            label: 'Remaining',
                            data: remainingData,
                            backgroundColor: '#e5e7eb',
                            borderRadius: 4,
                        }
                    ]
                },
                plugins: [
                    {
                        id: 'customLabels',
                        afterDatasetsDraw(chart) {
                            const { ctx, chartArea: { left, width } } = chart;
                            ctx.save();
                            
                            const meta = chart.getDatasetMeta(0); // Spent dataset
                            meta.data.forEach((bar, index) => {
                                const item = withLimits[index];
                                const y = bar.y;
                                const x = left + width / 2;
                                
                                const text = `₹${item.total.toLocaleString()} / ₹${item.limit.toLocaleString()}`;
                                
                                ctx.font = 'bold 11px sans-serif';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                
                                // Text shadow for visibility (softer than stroke)
                                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                                ctx.shadowBlur = 3;
                                
                                ctx.fillStyle = '#ffffff';
                                ctx.fillText(text, x, y);
                                
                                // Reset shadow
                                ctx.shadowColor = 'transparent';
                                ctx.shadowBlur = 0;
                            });
                            
                            ctx.restore();
                        }
                    }
                ],
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                // Custom title to show Category Name
                                title: function(context) {
                                    return context[0].label;
                                },
                                // Custom label to show absolute values instead of percentages
                                label: function(context) {
                                    const item = withLimits[context.dataIndex];
                                    if (context.dataset.label === 'Spent') {
                                        return `Spent: ₹${item.total.toLocaleString()} (${item.used_percent}%)`;
                                    } else {
                                        const remaining = Math.max(0, item.limit - item.total);
                                        return `Remaining: ₹${remaining.toLocaleString()}`;
                                    }
                                },
                                // Add limit info in footer
                                footer: function(context) {
                                    const item = withLimits[context[0].dataIndex];
                                    return `Limit: ₹${item.limit.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            stacked: true, 
                            display: false, // Hide X axis (0-100) since we want it to look like a loader
                            min: 0,
                            max: 100
                        },
                        y: { 
                            stacked: true, 
                            grid: { display: false },
                            ticks: { font: { weight: 'bold' } }
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}