<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    {% if GOOGLE_ANALYTICS_ID %}
    <!-- 1. Google Consent Mode v2 (Must be first) -->
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        
        // Define default consent (denied by default)
        const grantState = localStorage.getItem('cookieConsent') === 'accepted' ? 'granted' : 'denied';
        gtag('consent', 'default', {
            'ad_storage': grantState,
            'ad_user_data': grantState,
            'ad_personalization': grantState,
            'analytics_storage': grantState
        });
    </script>

    <!-- 2. Google Tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ GOOGLE_ANALYTICS_ID }}"></script>

    <!-- 3. Google Analytics Config -->
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '{{ GOOGLE_ANALYTICS_ID }}');
    </script>
    {% endif %}

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        document.cookie = "django_timezone=" + tz + "; path=/; SameSite=Lax";
    </script>
    <title>{% block title %}TrackMyRupee - Know Exactly Where Every Rupee Goes{% endblock %}</title>
    
    {% block meta_tags %}
    <meta name="description" content="Turn financial chaos into clarity. TrackMyRupee gives you a precision dashboard to visualize your spending, spot trends, and master your monthly budgetâ€”all in one place.">
    <meta name="keywords" content="TrackMyRupee, finance, expense tracker, budget, personal finance, money management, django, rupee tracker">
    <meta name="author" content="Omkar Pathak">

    <!-- Google Fonts (Unifying with Landing Page) -->
    <link href="https://fonts.googleapis.com/css2?family=Clash+Display:wght@400;500;600;700&family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:title" content="TrackMyRupee - Know Exactly Where Every Rupee Goes">
    <meta property="og:description" content="Stop Guessing. Start Growing. Track your expenses and master your budget with TrackMyRupee.">
    {% endblock %}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="{{ request.build_absolute_uri }}">
    <meta name="twitter:title" content="TrackMyRupee- Know Exactly Where Every Rupee Goes">
    <meta name="twitter:description" content="Stop Guessing. Start Growing. Track your expenses and master your budget with TrackMyRupee.">
    <meta name="twitter:image" content="https://trackmyrupee.com/static/img/og-preview.png">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}?v=1.8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/1.1.2/css/bootstrap-multiselect.min.css">
    <style>
        /* Bootstrap Multiselect Premium Customization */
        
        /* The main button that looks like a select input */
        .multiselect.dropdown-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            height: 31px !important;
            padding: 0 0.5rem !important;
            background-color: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
            color: var(--bs-body-color);
            border-radius: 6px;
            font-weight: 400;
            text-align: left;
            overflow: hidden;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            font-size: 0.875rem; /* Match btn-sm */
        }

        .multiselect.dropdown-toggle:focus, 
        .multiselect.dropdown-toggle:active, 
        .btn-group.show .multiselect.dropdown-toggle {
            border-color: #00f2fe !important;
            box-shadow: 0 0 0 0.25rem rgba(0, 242, 254, 0.15) !important;
            outline: 0;
            color: var(--bs-body-color);
            background-color: var(--bs-body-bg);
        }

        /* Adjust the caret position */
        .multiselect.dropdown-toggle::after {
            margin-left: auto;
        }

        /* Dropdown Menu styling */
        .multiselect-container.dropdown-menu {
            border-radius: 8px !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25) !important;
            background-color: var(--bs-body-bg) !important;
            border: 1px solid var(--bs-border-color) !important;
            padding: 0.5rem 0;
            padding-left: 0 !important; /* Reset default UL padding */
            min-width: 100%;
            z-index: 1050;
            max-height: 350px; /* Approx 10 items */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Universal Fade In Animation */
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
            opacity: 0; 
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }



        /* Dropdown Items */
        .multiselect-container > li > a {
            padding: 8px 16px;
            color: var(--bs-body-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }

        .multiselect-container > li > a:hover {
            background-color: rgba(0, 242, 254, 0.05);
            color: var(--bs-body-color);
        }

        .multiselect-container > li.active > a {
            background-color: rgba(0, 242, 254, 0.1);
            color: var(--bs-body-color);
        }

        /* Custom Checkboxes inside the dropdown */
        
        /* Search Box Alignment Fix */
        .multiselect-container .multiselect-filter {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 4px !important;
            margin: 0 !important;
            border-bottom: 1px solid var(--bs-border-color);
            list-style: none !important;
            width: 100% !important;
            box-sizing: border-box !important;
            text-indent: 0 !important;
        }

        .multiselect-container .multiselect-filter .input-group-addon {
            display: none !important;
        }

        .multiselect-container .multiselect-filter .input-group {
            width: 100% !important;
            flex: 1 1 auto !important;
            margin: 0 !important;
            padding: 0 !important;
            display: flex !important;
        }

        .multiselect-container .multiselect-filter input {
            width: 100% !important;
            flex: 1 1 auto !important;
            margin: 0 !important;
            height: 30px !important; /* Compact height */
            padding: 0 12px !important; /* Text padding only */
            border-radius: 0 !important;
            font-size: 0.875rem !important;
            border: none !important; /* NO BORDER */
            background: transparent !important; /* NO BACKGROUND */
            color: var(--bs-body-color) !important;
            box-sizing: border-box !important;
            box-shadow: none !important;
        }

        .multiselect-container .multiselect-filter input:focus {
            outline: 0 !important;
            box-shadow: none !important; /* No glow, clean look */
        }

        /* Checkbox styling continued */
        .multiselect-container input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;

            width: 18px;
            height: 18px;
            border: 2px solid #ced4da;
            border-radius: 4px;
            margin-right: 10px;
            cursor: pointer;
            position: relative;
            vertical-align: middle;
            transition: all 0.2s ease;
            background-color: var(--bs-body-bg);
        }

        .multiselect-container input[type="checkbox"]:checked {
            background: var(--primary-gradient);
            border-color: transparent;
        }

        .multiselect-container input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 1px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        /* Fix label styling */
        .multiselect-container label.checkbox {
            display: flex;
            align-items: center;
            width: 100%;
            margin: 0;
            cursor: pointer;
        }
        
    </style>
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="theme-color" content="#023047">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TrackMyRupee">
    <link rel="icon" type="image/svg+xml" href="{% static 'img/logo.svg' %}">
    <link rel="apple-touch-icon" href="{% static 'img/logo.svg' %}">
    <link rel="apple-touch-startup-image" href="{% static 'img/pwa-icon-512.png' %}">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register("{% static 'sw.js' %}")
            .then(registration => {
              console.log('ServiceWorker registration successful');
            })
            .catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
    </script>
</head>

<body class="d-flex flex-column min-vh-100">
    {% if request.user.username == 'demo' %}
    <div class="alert alert-warning text-center fw-bold m-0 rounded-0 py-2 small shadow-sm position-relative z-3 d-flex justify-content-center align-items-center gap-2" role="alert">
        <span><i class="bi bi-exclamation-triangle-fill me-1"></i> DEMO MODE: Read-only access.</span>
        <span class="opacity-50">|</span>
        <a href="{% url 'demo_signup' %}" class="text-reset text-decoration-underline">Create Account</a>
        <span class="opacity-50">|</span>
        <form action="{% url 'account_logout' %}" method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-link p-0 align-baseline text-reset text-decoration-underline fw-bold" style="font-size: inherit;">
                Exit Demo
            </button>
        </form>
    </div>
    {% endif %}
    {% include "components/navbar.html" with is_landing=False %}

    <!-- iOS Install Instructions Modal -->
    <div class="modal fade" id="iosInstallModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center pt-0 pb-4">
                    <div class="mb-3 text-primary">
                        <i class="bi bi-apple display-1"></i>
                    </div>
                    <h5 class="fw-bold mb-3">Install TrackMyRupee</h5>
                    <p class="text-muted mb-4">Install this app on your iPhone for the best experience.</p>
                    
                    <div class="d-flex align-items-center justify-content-center gap-2 mb-3 text-start bg-body-tertiary p-3 rounded">
                        <i class="bi bi-share fs-4 text-primary"></i>
                        <span>1. Tap the <strong>Share</strong> button</span>
                    </div>
                    <div class="d-flex align-items-center justify-content-center gap-2 text-start bg-body-tertiary p-3 rounded">
                        <i class="bi bi-plus-square fs-4 text-primary"></i>
                        <span>2. Scroll down and tap <strong>Add to Home Screen</strong></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Install Logic -->
    <script>
        let deferredPrompt;
        const installBtn = document.getElementById('installAppBtn');
        const installContainer = document.getElementById('installAppContainer');
        const isIos = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

        // Only show if not already installed
        if (!isStandalone) {
            // Android/Chrome
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installContainer.style.display = 'block';
            });

            // iOS (Keep visible if iOS, but check specific heuristic if needed)
            if (isIos) {
                installContainer.style.display = 'block';
            }
        }

        if (installBtn) {
            installBtn.addEventListener('click', (e) => {
                if (isIos) {
                    new bootstrap.Modal(document.getElementById('iosInstallModal')).show();
                } else if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            installContainer.style.display = 'none';
                        }
                        deferredPrompt = null;
                    });
                }
            });
        }

        window.addEventListener('appinstalled', () => {
             installContainer.style.display = 'none';
             deferredPrompt = null;
             console.log('PWA was installed');
        });
    </script>

    <main class="container py-4 flex-grow-1">
        {% block content %}{% endblock %}
    </main>

    <footer class="mt-auto bg-body-tertiary border-top pt-5 pb-3">
        <div class="container">
            <div class="row g-4 justify-content-between">
                <!-- Brand & Description -->
                <div class="col-lg-4 mb-4 mb-lg-0">
                    <a href="/" class="d-flex align-items-center gap-2 mb-3 text-decoration-none">
                        <img src="{% static 'img/logo.svg' %}" alt="TMR" width="32" height="32" class="d-inline-block align-text-top rounded-3">
                        <span class="fs-4 fw-bold text-body">TrackMyRupee</span>
                    </a>
                    <p class="text-muted small mb-4">
                        Turn financial chaos into clarity. TrackMyRupee gives you a precision dashboard to visualize your spending, spot trends, and master your monthly budget.
                    </p>
                    <a href="https://rzp.io/rzp/AP7kBG2" target="_blank" class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm">
                        <i class="bi bi-heart-fill me-1 text-white"></i> Support Us
                    </a>
                </div>

                <!-- Links Columns -->
                <div class="col-lg-8">
                    <div class="row g-4 justify-content-lg-end">
                        
                        <!-- Product Column -->
                        <div class="col-6 col-sm-4">
                            <h5 class="fw-bold mb-3 small text-uppercase tracking-wider">Product</h5>
                            <ul class="list-unstyled mb-0 d-flex flex-column gap-2">
                                <li><a href="{% if not user.is_authenticated %}{% url 'landing' %}#features{% else %}{% url 'home' %}{% endif %}" class="text-decoration-none text-muted small hover-primary">Features</a></li>
                                <li><a href="{% if not user.is_authenticated %}{% url 'landing' %}#pricing{% else %}{% url 'pricing' %}{% endif %}" class="text-decoration-none text-muted small hover-primary">Pricing</a></li>
                                <li><a href="{% url 'blog_list' %}" class="text-decoration-none text-muted small hover-primary">Blog</a></li>
                                <li><a href="{% url 'demo_login' %}" class="text-decoration-none text-muted small hover-primary">Live Demo</a></li>
                            </ul>
                        </div>

                        <!-- Company Column -->
                        <div class="col-6 col-sm-4">
                            <h5 class="fw-bold mb-3 small text-uppercase tracking-wider">Company</h5>
                            <ul class="list-unstyled mb-0 d-flex flex-column gap-2">
                                <li><a href="{% url 'about' %}" class="text-decoration-none text-muted small hover-primary">About</a></li>
                                <li><a href="{% url 'contact' %}" class="text-decoration-none text-muted small hover-primary">Contact</a></li>
                                <!-- <li><a href="#" class="text-decoration-none text-muted small hover-primary">FAQs</a></li> -->
                            </ul>
                        </div>

                        <!-- Legal Column -->
                        <div class="col-6 col-sm-4">
                            <h5 class="fw-bold mb-3 small text-uppercase tracking-wider">Legal</h5>
                            <ul class="list-unstyled mb-0 d-flex flex-column gap-2">
                                <li><a href="{% url 'privacy-policy' %}" class="text-decoration-none text-muted small hover-primary">Privacy Policy</a></li>
                                <li><a href="{% url 'terms-of-service' %}" class="text-decoration-none text-muted small hover-primary">Terms of Service</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-4 opacity-10">

            <div class="row align-items-center">
                <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                    <p class="text-muted small mb-0">&copy; {% now "Y" %} TrackMyRupee. All rights reserved.</p>
                </div>
                <div class="col-md-6 text-center text-md-end">
                   <!-- Social links could go here -->
                </div>
            </div>
        </div>
    </footer>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteModalBody">Are you sure you want to delete this item?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteForm" method="post" action="">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var deleteModal = document.getElementById('deleteModal');
            if (deleteModal) {
                deleteModal.addEventListener('show.bs.modal', function(event) {
                    // Button that triggered the modal
                    var button = event.relatedTarget;
                    // Extract info from data-attributes
                    var url = button.getAttribute('data-url');
                    var message = button.getAttribute('data-message');
                    
                    // Update the modal's content.
                    var form = deleteModal.querySelector('#deleteForm');
                    form.action = url;
                    
                    var modalBody = deleteModal.querySelector('#deleteModalBody');
                    if (message) {
                        modalBody.textContent = message;
                    } else {
                        modalBody.textContent = "Are you sure you want to delete this item?";
                    }
                });
            }
        });
    </script>

    <!-- Button Loader Utility -->
    <script>
        // Set button to loading state
        window.setButtonLoading = function(button, text = 'Processing...') {
            if (!button) return;
            // Save original content
            if (!button.getAttribute('data-original-content')) {
                button.setAttribute('data-original-content', button.innerHTML);
            }
            // Create spinner
            const spinner = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>';
            
            // If it's an icon-only button (empty or just whitespace text), don't add text
            const hasText = button.textContent.trim().length > 0;
            
            // Set width to prevent jumping (optional, but good)
            button.style.width = getComputedStyle(button).width;
            
            button.classList.add('disabled'); // Bootstrap disabled style
            // For links, we can't use .disabled property effectively for click prevention in all cases, but CSS pointer-events helps
            button.style.pointerEvents = 'none'; 
            
            if (hasText) {
                button.innerHTML = spinner + text;
            } else {
                button.innerHTML = spinner;
            }
        };

        // Global Form Submit Handler (covers Save & Delete buttons in forms)
        document.addEventListener('submit', function(e) {
            const form = e.target;
            // Find valid submit button (exclude disabled ones to avoid double triggering if logic exists)
            const submitBtn = form.querySelector('button[type="submit"]:not(.no-loader)'); 
            if (submitBtn && !e.defaultPrevented) {
                // If it's a delete button, use "Deleting..."
                const isDelete = submitBtn.classList.contains('btn-danger') || submitBtn.textContent.toLowerCase().includes('delete');
                const isLogin = submitBtn.textContent.toLowerCase().includes('sign in') || submitBtn.textContent.toLowerCase().includes('login');
                const isLogout = submitBtn.textContent.toLowerCase().includes('logout');
                
                let loadingText = 'Saving';
                if (isDelete) {
                    loadingText = 'Deleting';
                } else if (isLogin) {
                    loadingText = 'Logging in';
                } else if (isLogout) {
                    loadingText = 'Bye';
                } else if (submitBtn.textContent.toLowerCase().includes('continue')) {
                    loadingText = 'Signing in';
                }
                
                setButtonLoading(submitBtn, loadingText);
            }
        });
    </script>
    <script>
        // Reset buttons on page show (bfcache restoration)
        window.addEventListener('pageshow', function(event) {
            // Restore all buttons that were put into loading state
            document.querySelectorAll('button[data-original-content]').forEach(function(btn) {
                btn.innerHTML = btn.getAttribute('data-original-content');
                btn.classList.remove('disabled');
                btn.style.pointerEvents = '';
            });
        });
    </script>

    <!-- Block for Modals -->
    {% block modals %}{% endblock %}

    <!-- Global Loader Overlay -->
    <div id="page-loader" class="position-fixed top-0 start-0 w-100 h-100 d-none justify-content-center align-items-center" 
         style="background: rgba(var(--bs-body-bg-rgb), 0.8); z-index: 20000; backdrop-filter: blur(2px);">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Global Loader Logic -->
    <script>
        const loader = document.getElementById('page-loader');

        window.showLoader = function() {
            if (loader) loader.classList.remove('d-none');
            if (loader) loader.classList.add('d-flex');
        };

        window.hideLoader = function() {
            if (loader) loader.classList.remove('d-flex');
            if (loader) loader.classList.add('d-none');
        };

        // 1. Handle Programmatic Form Submits
        (function() {
            const originalSubmit = HTMLFormElement.prototype.submit;
            HTMLFormElement.prototype.submit = function() {
                if (!this.classList.contains('no-loader') && this.target !== '_blank') {
                    showLoader();
                }
                originalSubmit.apply(this, arguments);
            };
        })();

        // 2. Handle Standard Form Submits
        document.addEventListener('submit', function(e) {
            if (!e.defaultPrevented) {
                const form = e.target;
                if (!form.classList.contains('no-loader') && form.target !== '_blank') {
                    showLoader();
                }
            }
        });

        // 3. Handle Link Clicks
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            
            if (!link || !link.href) return;
            
            // Ignore modifiers and new tabs
            if (e.ctrlKey || e.metaKey || e.shiftKey || e.altKey || link.target === '_blank') return;
            
            // Ignore download links
            if (link.hasAttribute('download')) return;
            
            // Ignore explicit no-loader
            if (link.classList.contains('no-loader')) return;

            // Ignore UI Toggles (Bootstrap, etc)
            if (link.hasAttribute('data-bs-toggle') || link.hasAttribute('data-bs-dismiss')) return;

            // Ignore standard protocols that don't unload page
            if (link.href.startsWith('javascript:') || 
                link.href.startsWith('mailto:') || 
                link.href.startsWith('tel:')) return;

            // Robust Hash Check
            const hrefAttr = link.getAttribute('href');
            if (!hrefAttr || hrefAttr === '#') return; // Empty or just hash
            
            // Check for in-page anchors
            if (hrefAttr.startsWith('#')) {
                return;
            }

            // Check if it's a full URL processing to the same page with a hash
            // e.g. /path/to/page#section vs /path/to/page
            try {
                const url = new URL(link.href);
                const isSamePage = (url.origin === location.origin) && 
                                   (url.pathname === location.pathname) && 
                                   (url.search === location.search);
                
                if (isSamePage && url.hash) {
                    return;
                }
            } catch (err) {
                // If URL parsing fails, assume it's just a path and proceed
            }

            // Show loader for all valid navigations
            showLoader();
        });

        // Hide on Back Button (bfcache)
        window.addEventListener('pageshow', function(event) {
            hideLoader();
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>
        (() => {
            'use strict'

            const getStoredTheme = () => localStorage.getItem('theme')
            const setStoredTheme = theme => localStorage.setItem('theme', theme)

            const getPreferredTheme = () => {
                const storedTheme = getStoredTheme()
                if (storedTheme) {
                    return storedTheme
                }
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
            }

            const setTheme = theme => {
                if (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.setAttribute('data-bs-theme', 'dark')
                } else {
                    document.documentElement.setAttribute('data-bs-theme', theme)
                }
            }

            const updateIcon = (theme) => {
                const icon = document.getElementById('theme-icon');
                if (!icon) return;
                
                if (theme === 'dark') {
                    icon.classList.remove('bi-moon-stars-fill');
                    icon.classList.add('bi-sun-fill');
                } else {
                    icon.classList.remove('bi-sun-fill');
                    icon.classList.add('bi-moon-stars-fill');
                }
            }

            // Init
            const initialTheme = getPreferredTheme();
            setTheme(initialTheme);

            window.addEventListener('DOMContentLoaded', () => {
                const toggle = document.getElementById('theme-toggle');
                updateIcon(getPreferredTheme());

                if (toggle) {
                    toggle.addEventListener('click', () => {
                        const currentTheme = document.documentElement.getAttribute('data-bs-theme');
                        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                        
                        setStoredTheme(newTheme);
                        setTheme(newTheme);
                        updateIcon(newTheme);
                    });
                }
            });
        })()
    </script>
    {% if user.is_authenticated %}
    <!-- Floating Action Button (Mobile Only) -->
    <div class="position-fixed bottom-0 end-0 p-4 d-md-none" style="z-index: 1050;">
        <div class="dropdown">
            <button id="global-fab" class="btn btn-primary btn-lg rounded-circle shadow-lg d-flex align-items-center justify-content-center" 
                    style="width: 60px; height: 60px;" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-plus-lg fs-2"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow border-0 mb-2">
                <li>
                    <a class="dropdown-item py-2 d-flex align-items-center" href="{% url 'expense-create' %}">
                        <i class="bi bi-dash-circle text-primary me-2"></i> Add Expense
                    </a>
                </li>
                <li>
                    <a class="dropdown-item py-2 d-flex align-items-center" href="{% url 'income-create' %}">
                        <i class="bi bi-plus-circle text-success me-2"></i> Add Income
                    </a>
                </li>
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- Django Messages Toast Container -->
    {% if messages %}
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11000;">
        {% for message in messages %}
        <div class="toast align-items-center text-bg-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} border-0 shadow-lg mb-2" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    {% if message.tags == 'error' %}
                        <i class="bi bi-exclamation-circle-fill me-2"></i>
                    {% elif message.tags == 'success' %}
                        <i class="bi bi-check-circle-fill me-2"></i>
                    {% endif %}
                    {{ message }}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
        {% endfor %}
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var toasts = document.querySelectorAll('.toast');
            toasts.forEach(function(toastEl) {
                // Determine if this is a donation toast (which has manual control) or a message toast
                if (!toastEl.id || toastEl.id !== 'donationToast') {
                   var toast = new bootstrap.Toast(toastEl, { delay: 5000 });
                   toast.show();
                }
            });
        });
    </script>
    {% endif %}

    <!-- jQuery (Required for Bootstrap Multiselect) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="{% static 'js/bootstrap-multiselect.js' %}"></script>

    <script>
        // Global Bootstrap Multiselect Initialization
        // Usage: Add class 'django-multi-select' to any <select multiple>
        const initGlobalMultiselects = () => {
            $('.django-multi-select').each(function() {
                const placeholder = $(this).attr('placeholder') || 'Select...';
                $(this).multiselect({
                    buttonWidth: '100%',
                    nonSelectedText: placeholder,
                    nSelectedText: ' - Selected',
                    allSelectedText: 'All Selected',
                    numberDisplayed: 1,
                    includeSelectAllOption: true,
                    enableFiltering: true,
                    enableCaseInsensitiveFiltering: true,
                    filterPlaceholder: 'Search...',
                    buttonClass: 'btn btn-outline-secondary form-select form-select-sm text-start d-flex align-items-center justify-content-between',
                    templates: {
                        button: '<button type="button" class="multiselect dropdown-toggle" data-bs-toggle="dropdown" data-bs-boundary="viewport"><span class="multiselect-selected-text"></span></button>'
                    }
                });
            });
        };



        $(document).ready(function() {
            initGlobalMultiselects();
        });
    </script>
    <!-- Donation Notification Toast -->
    <div class="toast-container position-fixed bottom-0 start-0 p-3" style="z-index: 1100;">
        <div id="donationToast" class="toast border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
            <div class="toast-header bg-primary text-white">
                <i class="bi bi-heart-fill me-2"></i>
                <strong class="me-auto">Support TrackMyRupee</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body bg-body-tertiary">
                <p class="mb-2">If TrackMyRupee helped you understand your money better, consider supporting its development.</p>
                <a href="https://rzp.io/rzp/AP7kBG2" target="_blank" class="btn btn-primary btn-sm w-100">
                    <i class="bi bi-box-arrow-up-right me-1"></i> Donate Now
                </a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const NAG_INTERVAL = 20 * 60 * 1000; // 20 minutes
            const toastElement = document.getElementById('donationToast');
            const donationToast = new bootstrap.Toast(toastElement);

            function showDonationNag() {
                const lastNag = localStorage.getItem('last_donation_nag');
                const now = Date.now();

                if (!lastNag || (now - parseInt(lastNag)) > NAG_INTERVAL) {
                    donationToast.show();
                    localStorage.setItem('last_donation_nag', now.toString());
                }
            }

            // check every minute
            setInterval(showDonationNag, 60 * 1000);
            
            // Initial check after 10 seconds
            setTimeout(showDonationNag, 10000);
        });
    </script>

    <!-- Driver.js for Tutorial -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>
    
    {% include 'components/cookie_consent.html' %}
    
    {% block scripts %}{% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <script src="{% static 'js/tutorial.js' %}"></script>
    <script>
        // Set the URL for marking tutorial as complete globally for tutorial.js
        window.tutorialCompleteUrl = "{% url 'complete-tutorial' %}";
        
        {% if show_tutorial %}
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const mode = window.isOnboarding ? 'onboarding' : 'standard';
                startTour(mode);
            }, 1000); 
        });
        {% endif %}
    </script>
</body>

</html>